# Token Claims ä¼ä¸šçº§è§„èŒƒå¯¹æ¯”

## æ ‡å‡†è§„èŒƒå‚è€ƒ

- **OAuth 2.1** (RFC 6749, RFC 8252)
- **OpenID Connect 1.0** (OIDC Core 1.0)
- **JWT** (RFC 7519)

---

## 1. Access Token å­—æ®µè§„èŒƒ

### 1.1 æ ‡å‡†å¿…éœ€å­—æ®µï¼ˆç”±æ¡†æ¶è‡ªåŠ¨æ·»åŠ ï¼‰

| å­—æ®µ    | ç±»å‹         | è¯´æ˜                         | æ˜¯å¦è‡ªåŠ¨æ·»åŠ     |
| ------- | ------------ | ---------------------------- | --------------- |
| `iss`   | String       | ç­¾å‘è€…ï¼ˆIssuerï¼‰             | âœ… æ¡†æ¶è‡ªåŠ¨     |
| `sub`   | String       | ä¸»é¢˜ï¼ˆSubjectï¼Œç”¨æˆ·æ ‡è¯†ï¼‰    | âœ… æ¡†æ¶è‡ªåŠ¨     |
| `aud`   | String/Array | å—ä¼—ï¼ˆAudienceï¼Œèµ„æºæœåŠ¡å™¨ï¼‰ | âœ… æ¡†æ¶è‡ªåŠ¨     |
| `exp`   | Number       | è¿‡æœŸæ—¶é—´ï¼ˆUnix æ—¶é—´æˆ³ï¼‰      | âœ… æ¡†æ¶è‡ªåŠ¨     |
| `iat`   | Number       | ç­¾å‘æ—¶é—´ï¼ˆUnix æ—¶é—´æˆ³ï¼‰      | âœ… æ¡†æ¶è‡ªåŠ¨     |
| `jti`   | String       | JWT IDï¼ˆå”¯ä¸€æ ‡è¯†ï¼‰           | âœ… æ¡†æ¶è‡ªåŠ¨     |
| `scope` | String       | æˆæƒèŒƒå›´ï¼ˆç©ºæ ¼åˆ†éš”ï¼‰         | âš ï¸ éœ€è¦æ‰‹åŠ¨æ·»åŠ  |

### 1.2 ä¼ä¸šçº§æ¨èå­—æ®µ

| å­—æ®µ          | ç±»å‹          | è¯´æ˜                                         | å½“å‰å®ç°  | ä¼˜å…ˆçº§ |
| ------------- | ------------- | -------------------------------------------- | --------- | ------ |
| `userId`      | Number        | ç”¨æˆ· IDï¼ˆæ•°æ®åº“ä¸»é”®ï¼‰                        | âœ… å·²å®ç° | é«˜     |
| `username`    | String        | ç”¨æˆ·å                                       | âœ… å·²å®ç° | é«˜     |
| `authorities` | Array<String> | æƒé™åˆ—è¡¨ï¼ˆè§’è‰²+èµ„æºæƒé™ï¼‰                    | âœ… å·²å®ç° | é«˜     |
| `client_id`   | String        | å®¢æˆ·ç«¯ ID                                    | âœ… å·²å®ç° | é«˜     |
| `scope`       | String        | æˆæƒèŒƒå›´                                     | âœ… å·²å®ç° | é«˜     |
| `auth_time`   | Number        | ç”¨æˆ·è®¤è¯æ—¶é—´ï¼ˆUnix æ—¶é—´æˆ³ï¼‰                  | âŒ æœªå®ç° | ä¸­     |
| `acr`         | String        | è®¤è¯ä¸Šä¸‹æ–‡ç±»ï¼ˆAuthentication Context Classï¼‰ | âŒ æœªå®ç° | ä½     |
| `amr`         | Array<String> | è®¤è¯æ–¹æ³•å¼•ç”¨ï¼ˆå¦‚ password, totpï¼‰            | âŒ æœªå®ç° | ä¸­     |
| `tenant_id`   | String        | ç§Ÿæˆ· IDï¼ˆå¤šç§Ÿæˆ·åœºæ™¯ï¼‰                        | âŒ æœªå®ç° | ä½     |
| `device_id`   | String        | è®¾å¤‡ ID                                      | âŒ æœªå®ç° | ä½     |

### 1.3 å½“å‰å®ç°çŠ¶æ€

âœ… **å·²å®ç°**ï¼š

- `userId` - ç”¨æˆ· ID
- `username` - ç”¨æˆ·å
- `authorities` - æƒé™åˆ—è¡¨
- `client_id` - å®¢æˆ·ç«¯ ID
- `scope` - æˆæƒèŒƒå›´

âŒ **ç¼ºå¤±**ï¼š

- `auth_time` - ç”¨æˆ·è®¤è¯æ—¶é—´
- `amr` - è®¤è¯æ–¹æ³•ï¼ˆå¦‚ password, totpï¼‰

---

## 2. ID Token å­—æ®µè§„èŒƒ

### 2.1 æ ‡å‡†å¿…éœ€å­—æ®µï¼ˆç”±æ¡†æ¶è‡ªåŠ¨æ·»åŠ ï¼‰

| å­—æ®µ        | ç±»å‹         | è¯´æ˜                 | æ˜¯å¦è‡ªåŠ¨æ·»åŠ                   |
| ----------- | ------------ | -------------------- | ----------------------------- |
| `iss`       | String       | ç­¾å‘è€…               | âœ… æ¡†æ¶è‡ªåŠ¨                   |
| `sub`       | String       | ä¸»é¢˜ï¼ˆç”¨æˆ·å”¯ä¸€æ ‡è¯†ï¼‰ | âœ… æ¡†æ¶è‡ªåŠ¨                   |
| `aud`       | String/Array | å—ä¼—ï¼ˆå®¢æˆ·ç«¯ IDï¼‰    | âœ… æ¡†æ¶è‡ªåŠ¨                   |
| `exp`       | Number       | è¿‡æœŸæ—¶é—´             | âœ… æ¡†æ¶è‡ªåŠ¨                   |
| `iat`       | Number       | ç­¾å‘æ—¶é—´             | âœ… æ¡†æ¶è‡ªåŠ¨                   |
| `auth_time` | Number       | ç”¨æˆ·è®¤è¯æ—¶é—´         | âš ï¸ éœ€è¦æ‰‹åŠ¨æ·»åŠ                |
| `nonce`     | String       | é˜²é‡æ”¾æ”»å‡»éšæœºå€¼     | âœ… æ¡†æ¶è‡ªåŠ¨ï¼ˆå¦‚æœè¯·æ±‚ä¸­åŒ…å«ï¼‰ |

### 2.2 æ ‡å‡†å¯é€‰å­—æ®µï¼ˆæ ¹æ® scope è¯·æ±‚ï¼‰

| å­—æ®µ                    | ç±»å‹    | è¯´æ˜             | Scope è¦æ±‚ | å½“å‰å®ç°  |
| ----------------------- | ------- | ---------------- | ---------- | --------- |
| `name`                  | String  | ç”¨æˆ·å…¨å/æ˜µç§°    | `profile`  | âŒ æœªå®ç° |
| `given_name`            | String  | å               | `profile`  | âŒ æœªå®ç° |
| `family_name`           | String  | å§“               | `profile`  | âŒ æœªå®ç° |
| `middle_name`           | String  | ä¸­é—´å           | `profile`  | âŒ æœªå®ç° |
| `nickname`              | String  | æ˜µç§°             | `profile`  | âŒ æœªå®ç° |
| `preferred_username`    | String  | é¦–é€‰ç”¨æˆ·å       | `profile`  | âŒ æœªå®ç° |
| `profile`               | String  | ç”¨æˆ·èµ„æ–™é¡µé¢ URL | `profile`  | âŒ æœªå®ç° |
| `picture`               | String  | ç”¨æˆ·å¤´åƒ URL     | `profile`  | âŒ æœªå®ç° |
| `website`               | String  | ç”¨æˆ·ç½‘ç«™         | `profile`  | âŒ æœªå®ç° |
| `gender`                | String  | æ€§åˆ«             | `profile`  | âŒ æœªå®ç° |
| `birthdate`             | String  | ç”Ÿæ—¥             | `profile`  | âŒ æœªå®ç° |
| `zoneinfo`              | String  | æ—¶åŒº             | `profile`  | âŒ æœªå®ç° |
| `locale`                | String  | è¯­è¨€åŒºåŸŸ         | `profile`  | âŒ æœªå®ç° |
| `email`                 | String  | é‚®ç®±åœ°å€         | `email`    | âŒ æœªå®ç° |
| `email_verified`        | Boolean | é‚®ç®±æ˜¯å¦å·²éªŒè¯   | `email`    | âŒ æœªå®ç° |
| `phone_number`          | String  | æ‰‹æœºå·           | `phone`    | âŒ æœªå®ç° |
| `phone_number_verified` | Boolean | æ‰‹æœºå·æ˜¯å¦å·²éªŒè¯ | `phone`    | âŒ æœªå®ç° |
| `address`               | Object  | åœ°å€ä¿¡æ¯         | `address`  | âŒ æœªå®ç° |

### 2.3 ä¼ä¸šçº§è‡ªå®šä¹‰å­—æ®µ

| å­—æ®µ       | ç±»å‹          | è¯´æ˜                          | å½“å‰å®ç°  |
| ---------- | ------------- | ----------------------------- | --------- |
| `userId`   | Number        | ç”¨æˆ· IDï¼ˆæ•°æ®åº“ä¸»é”®ï¼‰         | âœ… å·²å®ç° |
| `username` | String        | ç”¨æˆ·å                        | âœ… å·²å®ç° |
| `amr`      | Array<String> | è®¤è¯æ–¹æ³•ï¼ˆå¦‚ password, totpï¼‰ | âŒ æœªå®ç° |

### 2.4 å½“å‰å®ç°çŠ¶æ€

âœ… **å·²å®ç°**ï¼š

- `sub` - ä¸»é¢˜ï¼ˆç”¨æˆ·åï¼‰
- `userId` - ç”¨æˆ· ID
- `username` - ç”¨æˆ·å

âŒ **ç¼ºå¤±ï¼ˆé‡è¦ï¼‰**ï¼š

- `auth_time` - ç”¨æˆ·è®¤è¯æ—¶é—´
- `name` / `nickname` - ç”¨æˆ·æ˜¾ç¤ºåç§°ï¼ˆéœ€è¦ä» User å®ä½“è·å–ï¼‰
- `email` / `email_verified` - é‚®ç®±ä¿¡æ¯ï¼ˆéœ€è¦ä» User å®ä½“è·å–ï¼‰
- `phone_number` / `phone_number_verified` - æ‰‹æœºå·ä¿¡æ¯ï¼ˆéœ€è¦ä» User å®ä½“è·å–ï¼‰
- `amr` - è®¤è¯æ–¹æ³•

---

## 3. Refresh Token å­—æ®µè§„èŒƒ

### 3.1 æ ‡å‡†å­—æ®µï¼ˆå¦‚æœé…ç½®ä¸º JWT æ ¼å¼ï¼‰

| å­—æ®µ  | ç±»å‹   | è¯´æ˜     | å½“å‰å®ç°    |
| ----- | ------ | -------- | ----------- |
| `iss` | String | ç­¾å‘è€…   | âœ… æ¡†æ¶è‡ªåŠ¨ |
| `sub` | String | ä¸»é¢˜     | âœ… æ¡†æ¶è‡ªåŠ¨ |
| `aud` | String | å—ä¼—     | âœ… æ¡†æ¶è‡ªåŠ¨ |
| `exp` | Number | è¿‡æœŸæ—¶é—´ | âœ… æ¡†æ¶è‡ªåŠ¨ |
| `iat` | Number | ç­¾å‘æ—¶é—´ | âœ… æ¡†æ¶è‡ªåŠ¨ |

### 3.2 ä¼ä¸šçº§æ¨èå­—æ®µ

| å­—æ®µ         | ç±»å‹   | è¯´æ˜         | å½“å‰å®ç°  |
| ------------ | ------ | ------------ | --------- |
| `userId`     | Number | ç”¨æˆ· ID      | âœ… å·²å®ç° |
| `username`   | String | ç”¨æˆ·å       | âœ… å·²å®ç° |
| `client_id`  | String | å®¢æˆ·ç«¯ ID    | âœ… å·²å®ç° |
| `grant_type` | String | æˆæƒç±»å‹     | âœ… å·²å®ç° |
| `scope`      | String | æˆæƒèŒƒå›´     | âœ… å·²å®ç° |
| `auth_time`  | Number | ç”¨æˆ·è®¤è¯æ—¶é—´ | âŒ æœªå®ç° |
| `device_id`  | String | è®¾å¤‡ ID      | âŒ æœªå®ç° |

### 3.3 å½“å‰å®ç°çŠ¶æ€

âœ… **å·²å®ç°**ï¼š

- `userId` - ç”¨æˆ· ID
- `username` - ç”¨æˆ·å
- `client_id` - å®¢æˆ·ç«¯ ID
- `grant_type` - æˆæƒç±»å‹
- `scope` - æˆæƒèŒƒå›´

âŒ **ç¼ºå¤±**ï¼š

- `auth_time` - ç”¨æˆ·è®¤è¯æ—¶é—´

---

## 4. ç¬¦åˆåº¦è¯„ä¼°

### 4.1 Access Token ç¬¦åˆåº¦ï¼š**75%** âœ…

**ä¼˜ç‚¹**ï¼š

- âœ… åŒ…å«æ ¸å¿ƒä¸šåŠ¡å­—æ®µï¼ˆuserId, username, authoritiesï¼‰
- âœ… åŒ…å«å®¢æˆ·ç«¯å’ŒæˆæƒèŒƒå›´ä¿¡æ¯

**æ”¹è¿›å»ºè®®**ï¼š

- âš ï¸ æ·»åŠ  `auth_time`ï¼ˆç”¨æˆ·è®¤è¯æ—¶é—´ï¼‰
- âš ï¸ æ·»åŠ  `amr`ï¼ˆè®¤è¯æ–¹æ³•ï¼Œå¦‚ password, totpï¼‰

### 4.2 ID Token ç¬¦åˆåº¦ï¼š**40%** âš ï¸

**ä¼˜ç‚¹**ï¼š

- âœ… åŒ…å«åŸºæœ¬ç”¨æˆ·æ ‡è¯†ï¼ˆsub, userId, usernameï¼‰

**ä¸¥é‡ç¼ºå¤±**ï¼š

- âŒ ç¼ºå°‘ `auth_time`ï¼ˆOIDC æ ‡å‡†å­—æ®µï¼‰
- âŒ ç¼ºå°‘ `name` / `nickname`ï¼ˆç”¨æˆ·æ˜¾ç¤ºåç§°ï¼‰
- âŒ ç¼ºå°‘ `email` / `email_verified`ï¼ˆé‚®ç®±ä¿¡æ¯ï¼‰
- âŒ ç¼ºå°‘ `phone_number` / `phone_number_verified`ï¼ˆæ‰‹æœºå·ä¿¡æ¯ï¼‰
- âŒ ç¼ºå°‘ `amr`ï¼ˆè®¤è¯æ–¹æ³•ï¼‰

**æ”¹è¿›å»ºè®®**ï¼š

- ğŸ”´ **é«˜ä¼˜å…ˆçº§**ï¼šæ·»åŠ  `auth_time`ã€`name`ã€`email`ã€`email_verified`
- ğŸŸ¡ **ä¸­ä¼˜å…ˆçº§**ï¼šæ·»åŠ  `phone_number`ã€`phone_number_verified`ã€`amr`
- ğŸŸ¢ **ä½ä¼˜å…ˆçº§**ï¼šæ·»åŠ å…¶ä»– profile å­—æ®µ

### 4.3 Refresh Token ç¬¦åˆåº¦ï¼š**85%** âœ…

**ä¼˜ç‚¹**ï¼š

- âœ… åŒ…å«å®Œæ•´çš„è¿½è¸ªä¿¡æ¯ï¼ˆuserId, username, client_id, grant_type, scopeï¼‰

**æ”¹è¿›å»ºè®®**ï¼š

- âš ï¸ æ·»åŠ  `auth_time`ï¼ˆç”¨æˆ·è®¤è¯æ—¶é—´ï¼‰

---

## 5. æ”¹è¿›å»ºè®®ä¼˜å…ˆçº§

### ğŸ”´ é«˜ä¼˜å…ˆçº§ï¼ˆå¿…é¡»å®ç°ï¼‰

1. **ID Token æ·»åŠ  `auth_time`**

   - OIDC æ ‡å‡†å¿…éœ€å­—æ®µ
   - ç”¨äºè¿½è¸ªç”¨æˆ·è®¤è¯æ—¶é—´

2. **ID Token æ·»åŠ ç”¨æˆ·åŸºæœ¬ä¿¡æ¯**

   - `name` / `nickname` - ä» User å®ä½“è·å–
   - `email` / `email_verified` - ä» User å®ä½“è·å–

3. **Access Token æ·»åŠ  `auth_time`**
   - ç”¨äºå®¡è®¡å’Œè¿½è¸ª

### ğŸŸ¡ ä¸­ä¼˜å…ˆçº§ï¼ˆå»ºè®®å®ç°ï¼‰

1. **æ·»åŠ  `amr`ï¼ˆè®¤è¯æ–¹æ³•ï¼‰**

   - Access Tokenã€ID Tokenã€Refresh Token éƒ½åº”åŒ…å«
   - ç”¨äºè¿½è¸ªè®¤è¯æ–¹å¼ï¼ˆpassword, totp ç­‰ï¼‰

2. **ID Token æ·»åŠ  `phone_number` / `phone_number_verified`**
   - å¦‚æœä¸šåŠ¡éœ€è¦æ‰‹æœºå·éªŒè¯

### ğŸŸ¢ ä½ä¼˜å…ˆçº§ï¼ˆå¯é€‰ï¼‰

1. å…¶ä»– profile å­—æ®µï¼ˆpicture, website, gender ç­‰ï¼‰
2. å¤šç§Ÿæˆ·æ”¯æŒï¼ˆtenant_idï¼‰
3. è®¾å¤‡è¿½è¸ªï¼ˆdevice_idï¼‰

---

## 6. å®ç°æ–¹æ¡ˆ

### 6.1 è·å–å®Œæ•´ User ä¿¡æ¯

ç”±äº `SecurityUser` åªåŒ…å«åŸºæœ¬ä¿¡æ¯ï¼Œéœ€è¦ä»ä»¥ä¸‹é€”å¾„è·å–å®Œæ•´ User ä¿¡æ¯ï¼š

1. **ä» OAuth2Authorization è·å–**ï¼ˆæ¨èï¼‰

   - é€šè¿‡ `context.getAuthorization()` è·å– `OAuth2Authorization`
   - ä» `OAuth2Authorization.getAttribute(Principal.class.getName())` è·å– Principal
   - ä½† Principal å¯èƒ½ä¹Ÿæ˜¯ `SecurityUser`ï¼Œéœ€è¦é¢å¤–æŸ¥è¯¢

2. **é€šè¿‡ UserRepository æŸ¥è¯¢**ï¼ˆå¤‡é€‰ï¼‰

   - æ ¹æ® `username` æŸ¥è¯¢å®Œæ•´çš„ `User` å®ä½“
   - è·å– `email`ã€`phone`ã€`nickname` ç­‰å­—æ®µ

3. **æ‰©å±• SecurityUser**ï¼ˆé•¿æœŸæ–¹æ¡ˆï¼‰
   - åœ¨ `SecurityUser` ä¸­æ·»åŠ  `email`ã€`phone`ã€`nickname` å­—æ®µ
   - ä¿®æ”¹ `UserDetailsServiceImpl` å¡«å……è¿™äº›å­—æ®µ

### 6.2 è·å–è®¤è¯æ–¹æ³•ï¼ˆamrï¼‰

ä» `Authentication` å¯¹è±¡ä¸­æå–ï¼š

- å¦‚æœæ˜¯ `MultiFactorAuthenticationToken`ï¼Œå¯ä»¥ä» `getCompletedFactors()` è·å–
- ä¾‹å¦‚ï¼š`["password", "totp"]`

### 6.3 è·å–è®¤è¯æ—¶é—´ï¼ˆauth_timeï¼‰

- ä» `Authentication` çš„åˆ›å»ºæ—¶é—´è·å–
- æˆ–ä» `OAuth2Authorization` çš„åˆ›å»ºæ—¶é—´è·å–

---

## 7. æ€»ç»“

å½“å‰å®ç°**åŸºæœ¬ç¬¦åˆ**ä¼ä¸šçº§è§„èŒƒï¼Œä½† **ID Token ç¼ºå°‘å…³é”®å­—æ®µ**ï¼Œéœ€è¦é‡ç‚¹æ”¹è¿›ï¼š

1. âœ… **Access Token**ï¼šç¬¦åˆåº¦ 75%ï¼Œå»ºè®®æ·»åŠ  `auth_time` å’Œ `amr`
2. âš ï¸ **ID Token**ï¼šç¬¦åˆåº¦ 40%ï¼Œ**éœ€è¦å¤§é‡æ”¹è¿›**ï¼Œç‰¹åˆ«æ˜¯ç”¨æˆ·ä¿¡æ¯å­—æ®µ
3. âœ… **Refresh Token**ï¼šç¬¦åˆåº¦ 85%ï¼Œå»ºè®®æ·»åŠ  `auth_time`

**ä¸‹ä¸€æ­¥è¡ŒåŠ¨**ï¼š

1. ä¼˜å…ˆå®ç° ID Token çš„ `auth_time`ã€`name`ã€`email`ã€`email_verified`
2. å®ç° `amr` å­—æ®µï¼ˆæ‰€æœ‰ token ç±»å‹ï¼‰
3. è€ƒè™‘æ‰©å±• `SecurityUser` æˆ–ä» `UserRepository` æŸ¥è¯¢å®Œæ•´ç”¨æˆ·ä¿¡æ¯
