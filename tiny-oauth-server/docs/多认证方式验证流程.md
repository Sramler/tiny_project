# å¤šè®¤è¯æ–¹å¼éªŒè¯æµç¨‹

## ğŸ“‹ æ¦‚è¿°

ç°åœ¨ç³»ç»Ÿæ”¯æŒæ ¹æ®ç™»å½•è¡¨å•ä¼ å…¥çš„ `authenticationProvider` å’Œ `authenticationType` å»æ•°æ®åº“åŠ¨æ€æŸ¥è¯¢å¯¹åº”çš„è®¤è¯æ–¹æ³•è¿›è¡ŒéªŒè¯ã€‚

---

## ğŸ”„ å®Œæ•´æµç¨‹

```
1. ç”¨æˆ·è®¿é—®ç™»å½•é¡µé¢
   â†“
2. æäº¤ç™»å½•è¡¨å•ï¼ˆåŒ…å« username, password, authenticationProvider, authenticationTypeï¼‰
   â†“
3. Spring Security æ•è·è¯·æ±‚ï¼Œåˆ›å»º UsernamePasswordAuthenticationToken
   â†“
4. CustomWebAuthenticationDetailsSource æå–é¢å¤–å‚æ•°
   â†“
5. MultiAuthenticationProvider.authenticate() è¢«è°ƒç”¨
   â†“
6. ä» CustomWebAuthenticationDetails è·å– provider å’Œ type
   â†“
7. æ ¹æ® provider + type å» user_authentication_method è¡¨æŸ¥è¯¢
   â†“
8. éªŒè¯è®¤è¯æ–¹æ³•æ˜¯å¦å­˜åœ¨ã€æ˜¯å¦å¯ç”¨
   â†“
9. æ ¹æ®è®¤è¯ç±»å‹è¿›è¡ŒéªŒè¯ï¼ˆPASSWORD/TOTPç­‰ï¼‰
   â†“
10. éªŒè¯æˆåŠŸååˆ›å»º Authentication å¯¹è±¡
```

---

## ğŸ’» æ ¸å¿ƒç»„ä»¶

### 1. CustomWebAuthenticationDetailsSource

ä»ç™»å½•è¡¨å•ä¸­æå–é¢å¤–å‚æ•°ï¼š

```java
// æå–çš„å‚æ•°
- authenticationProvider = "LOCAL"
- authenticationType = "PASSWORD"
```

### 2. MultiAuthenticationProvider

æ ¹æ®å‚æ•°æŸ¥è¯¢æ•°æ®åº“å¹¶éªŒè¯ï¼š

```java
// æŸ¥è¯¢ SQLï¼ˆç”± Repository ç”Ÿæˆï¼‰
SELECT * FROM user_authentication_method
WHERE user_id = ?
  AND authentication_provider = 'LOCAL'
  AND authentication_type = 'PASSWORD'
```

éªŒè¯æ­¥éª¤ï¼š

1. æ£€æŸ¥è®¤è¯æ–¹æ³•æ˜¯å¦å­˜åœ¨
2. æ£€æŸ¥æ˜¯å¦å¯ç”¨ï¼ˆis_method_enabled = trueï¼‰
3. æ ¹æ®è®¤è¯ç±»å‹æ‰§è¡Œå¯¹åº”çš„éªŒè¯é€»è¾‘
4. éªŒè¯æˆåŠŸåè¿”å› Authentication å¯¹è±¡

### 3. DefaultSecurityConfig

é…ç½®æ³¨å†Œï¼š

```82:82:tiny-oauth-server/src/main/java/com/tiny/oauthserver/config/DefaultSecurityConfig.java
                .authenticationProvider(multiAuthenticationProvider) // ä½¿ç”¨è‡ªå®šä¹‰çš„å¤šè®¤è¯æä¾›è€…
```

---

## ğŸ” æ•°æ®åº“éªŒè¯é€»è¾‘

### æŸ¥è¯¢è®¤è¯æ–¹æ³•

```java
Optional<UserAuthenticationMethod> methodOpt = authenticationMethodRepository
    .findByUserIdAndAuthenticationProviderAndAuthenticationType(user.getId(), provider, type);
```

### æ£€æŸ¥æ¡ä»¶

1. **å­˜åœ¨æ€§æ£€æŸ¥**

   ```java
   if (!methodOpt.isPresent()) {
       throw new BadCredentialsException("è¯¥ç”¨æˆ·æœªé…ç½®æ­¤è®¤è¯æ–¹å¼");
   }
   ```

2. **å¯ç”¨çŠ¶æ€æ£€æŸ¥**

   ```java
   if (!Boolean.TRUE.equals(method.getIsMethodEnabled())) {
       throw new BadCredentialsException("è¯¥è®¤è¯æ–¹å¼å·²è¢«ç¦ç”¨");
   }
   ```

3. **å¯†ç éªŒè¯**
   ```java
   String passwordHash = (String) config.get("passwordHash");
   if (!passwordEncoder.matches(password, passwordHash)) {
       throw new BadCredentialsException("å¯†ç é”™è¯¯");
   }
   ```

---

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

### å½“å‰ç™»å½•è¡¨å•

```html
<form method="post" th:action="@{/login}">
  <input name="username" />
  <input name="password" />

  <!-- è‡ªåŠ¨ä¼ å…¥çš„å‚æ•° -->
  <input type="hidden" name="authenticationProvider" value="LOCAL" />
  <input type="hidden" name="authenticationType" value="PASSWORD" />
</form>
```

### æ•°æ®åº“è¡¨ç»“æ„

`user_authentication_method` è¡¨ï¼š

| å­—æ®µ                         | ç±»å‹        | è¯´æ˜       | ç¤ºä¾‹                    |
| ---------------------------- | ----------- | ---------- | ----------------------- |
| user_id                      | BIGINT      | ç”¨æˆ· ID    | 1                       |
| authentication_provider      | VARCHAR(50) | è®¤è¯æä¾›è€… | "LOCAL"                 |
| authentication_type          | VARCHAR(50) | è®¤è¯ç±»å‹   | "PASSWORD"              |
| authentication_configuration | JSON        | è®¤è¯é…ç½®   | {"passwordHash": "..."} |
| is_method_enabled            | BOOLEAN     | æ˜¯å¦å¯ç”¨   | true                    |

### ç¤ºä¾‹æ•°æ®

```sql
INSERT INTO user_authentication_method
(user_id, authentication_provider, authentication_type, authentication_configuration, is_method_enabled)
VALUES
(1, 'LOCAL', 'PASSWORD', '{"passwordHash": "$2a$10$..."}', true);

-- å¯ä»¥æ·»åŠ å¤šç§è®¤è¯æ–¹å¼
INSERT INTO user_authentication_method
(user_id, authentication_provider, authentication_type, authentication_configuration, is_method_enabled)
VALUES
(1, 'LOCAL', 'TOTP', '{"secret": "JBSWY3DPEHPK3PXP"}', true);
```

---

## ğŸ¯ æ”¯æŒçš„è®¤è¯ç±»å‹

### 1. PASSWORDï¼ˆå·²å®ç°ï¼‰

```java
case "PASSWORD":
    return authenticatePassword(user, password, method);
```

éªŒè¯é€»è¾‘ï¼š

- ä» `authentication_configuration` ä¸­è·å– `passwordHash`
- ä½¿ç”¨ `passwordEncoder.matches()` éªŒè¯å¯†ç 
- éªŒè¯æˆåŠŸåè¿”å› Authentication

### 2. TOTPï¼ˆæ¡†æ¶å·²æä¾›ï¼‰

```java
case "TOTP":
    return authenticateTotp(user, password, method);
```

éœ€è¦å®ç° TOTP éªŒè¯é€»è¾‘ï¼ˆTODOï¼‰

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. é»˜è®¤å€¼å¤„ç†

å¦‚æœè¡¨å•æ²¡æœ‰ä¼ å…¥å‚æ•°ï¼Œä½¿ç”¨é»˜è®¤å€¼ï¼š

```java
String provider = "LOCAL";  // é»˜è®¤
String type = "PASSWORD";   // é»˜è®¤
```

### 2. è®¤è¯å¤±è´¥åŸå› 

- ç”¨æˆ·ä¸å­˜åœ¨
- æœªé…ç½®è¯¥è®¤è¯æ–¹å¼
- è®¤è¯æ–¹å¼è¢«ç¦ç”¨
- å¯†ç /éªŒè¯ç é”™è¯¯
- è®¤è¯é…ç½®é”™è¯¯

### 3. æ—¥å¿—è®°å½•

ç³»ç»Ÿä¼šè®°å½•å…³é”®æ“ä½œï¼š

```java
logger.debug("ä»è¯·æ±‚ä¸­è·å–è®¤è¯å‚æ•°: provider={}, type={}", provider, type);
logger.warn("ç”¨æˆ· {} æœªé…ç½® {} + {} è®¤è¯æ–¹æ³•", username, provider, type);
logger.warn("ç”¨æˆ· {} å¯†ç éªŒè¯å¤±è´¥", user.getUsername());
```

---

## ğŸ“š ç›¸å…³æ–‡ä»¶

- `MultiAuthenticationProvider.java` - å¤šè®¤è¯æä¾›è€…å®ç°
- `CustomWebAuthenticationDetailsSource.java` - å‚æ•°æå–
- `DefaultSecurityConfig.java` - Spring Security é…ç½®
- `UserAuthenticationMethod.java` - æ•°æ®åº“å®ä½“
- `login.html` - ç™»å½•è¡¨å•

---

## ğŸš€ æ‰©å±•å…¶ä»–è®¤è¯æ–¹å¼

è¦æ·»åŠ æ–°çš„è®¤è¯ç±»å‹ï¼ˆå¦‚ LDAPã€OAuthï¼‰ï¼Œåªéœ€åœ¨ `MultiAuthenticationProvider.authenticate()` ä¸­æ·»åŠ æ–°çš„ caseï¼š

```java
switch (type) {
    case "PASSWORD":
        return authenticatePassword(user, password, method);
    case "TOTP":
        return authenticateTotp(user, password, method);
    case "LDAP":           // æ–°å¢
        return authenticateLdap(user, password, method);
    default:
        throw new BadCredentialsException("ä¸æ”¯æŒçš„è®¤è¯ç±»å‹: " + type);
}
```

