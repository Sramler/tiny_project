# ç™»å½•æµç¨‹ä¼˜åŒ–æ€»ç»“

## ğŸ“‹ æ¦‚è¿°

æœ¬æ¬¡ä¼˜åŒ–å¯¹ `tiny-oauth-server` é¡¹ç›®çš„ç™»å½•æµç¨‹è¿›è¡Œäº†å…¨é¢é‡æ„ï¼Œæå‡äº†ä»£ç è´¨é‡ã€ç±»å‹å®‰å…¨æ€§ã€å¯ç»´æŠ¤æ€§å’Œæ€§èƒ½ã€‚

---

## ğŸ¯ æ ¸å¿ƒä¼˜åŒ–ç‚¹

### 1. **ç±»å‹å®‰å…¨ä¼˜åŒ– - MultiFactorAuthenticationToken é‡æ„**

#### ä¼˜åŒ–å‰
- ä½¿ç”¨å­—ç¬¦ä¸²è¡¨ç¤º `authenticationProvider` å’Œ `authenticationType`
- ä½¿ç”¨ `Set<String>` å­˜å‚¨å·²å®Œæˆçš„è®¤è¯å› å­
- å®¹æ˜“å‡ºç°æ‹¼å†™é”™è¯¯å’Œç±»å‹ä¸åŒ¹é…é—®é¢˜

#### ä¼˜åŒ–å
- âœ… å¼•å…¥ `Provider` æšä¸¾ï¼ˆLOCAL, GITHUB, GOOGLE, LDAP, UNKNOWNï¼‰
- âœ… å¼•å…¥ `Factor` æšä¸¾ï¼ˆPASSWORD, TOTP, OAUTH2, EMAIL, MFA, UNKNOWNï¼‰
- âœ… ä½¿ç”¨ `EnumSet<Factor>` æ›¿ä»£ `Set<String>`
- âœ… ç¼–è¯‘æœŸç±»å‹æ£€æŸ¥ï¼Œé¿å…è¿è¡Œæ—¶é”™è¯¯
- âœ… æ›´å¥½çš„ IDE è‡ªåŠ¨è¡¥å…¨å’Œé‡æ„æ”¯æŒ

#### æ€§èƒ½æå‡
- `EnumSet` æ˜¯é«˜æ€§èƒ½çš„ `Set` å®ç°ï¼Œä¸“ä¸ºæšä¸¾ç±»å‹ä¼˜åŒ–
- å†…å­˜å ç”¨æ›´å°ï¼ˆä½å‘é‡å®ç°ï¼‰
- æ“ä½œé€Ÿåº¦æ›´å¿«ï¼ˆO(1) å¤æ‚åº¦ï¼‰

#### ä»£ç ç¤ºä¾‹
```java
// ä¼˜åŒ–å‰
MultiFactorAuthenticationToken token = new MultiFactorAuthenticationToken(
    username, password, "LOCAL", "PASSWORD"
);
Set<String> completed = new HashSet<>();
completed.add("PASSWORD");

// ä¼˜åŒ–å
MultiFactorAuthenticationToken token = new MultiFactorAuthenticationToken(
    username, password, Provider.LOCAL, Factor.PASSWORD
);
EnumSet<Factor> completed = EnumSet.of(Factor.PASSWORD);
```

---

### 2. **Jackson åºåˆ—åŒ–ä¼˜åŒ–**

#### ä¼˜åŒ–å‰
- `credentials` å­—æ®µå¯èƒ½è¢«æ„å¤–åºåˆ—åŒ–ï¼Œå­˜åœ¨å®‰å…¨é£é™©
- ååºåˆ—åŒ–æ—¶å¯èƒ½å‡ºç°ç±»å‹é—®é¢˜

#### ä¼˜åŒ–å
- âœ… ä½¿ç”¨ `@JsonIgnore` ä¿æŠ¤æ•æ„Ÿä¿¡æ¯ï¼ˆcredentialsï¼‰
- âœ… æ·»åŠ  `@JsonCreator` å·¥å‚æ–¹æ³•ï¼Œæ”¯æŒå¥å£®çš„ååºåˆ—åŒ–
- âœ… ç§»é™¤ç±»çº§åˆ«çš„ `@JsonTypeInfo`ï¼Œé¿å…åºåˆ—åŒ–é—®é¢˜
- âœ… æ”¯æŒå‘åå…¼å®¹ï¼ˆåŒæ—¶æ”¯æŒæ–°æ—§å­—æ®µåï¼‰

#### å®‰å…¨æå‡
- é˜²æ­¢æ•æ„Ÿå‡­è¯ä¿¡æ¯æ³„éœ²åˆ°æ—¥å¿—æˆ– JSON å“åº”ä¸­
- æ˜ç¡®æ§åˆ¶å“ªäº›å­—æ®µå¯ä»¥è¢«åºåˆ—åŒ–

---

### 3. **TOTP éªŒè¯é€»è¾‘æå– - TotpService**

#### ä¼˜åŒ–å‰
- TOTP éªŒè¯é€»è¾‘åˆ†æ•£åœ¨å¤šä¸ªç±»ä¸­ï¼ˆ`MultiAuthenticationProvider`ã€`SecurityServiceImpl`ï¼‰
- ä»£ç é‡å¤ï¼Œéš¾ä»¥ç»´æŠ¤å’Œæµ‹è¯•

#### ä¼˜åŒ–å
- âœ… åˆ›å»ºç‹¬ç«‹çš„ `TotpService` æœåŠ¡ç±»
- âœ… ç»Ÿä¸€ç®¡ç† TOTP éªŒè¯é€»è¾‘
- âœ… æ”¯æŒå¯é…ç½®çš„æ—¶é—´çª—å£ï¼ˆé»˜è®¤ Â±1 æ­¥é•¿ï¼‰
- âœ… è‡ªåŠ¨æ¸…æ´— Base32 secretï¼ˆå»é™¤ç©ºæ ¼ã€ç»Ÿä¸€å¤§å°å†™ï¼‰
- âœ… å¤ç”¨ `TimeBasedOneTimePasswordGenerator` å®ä¾‹ï¼Œæé«˜æ€§èƒ½

#### ä»£ç å¤ç”¨
```java
// ä¼˜åŒ–å‰ï¼šé€»è¾‘åˆ†æ•£
// MultiAuthenticationProvider.authenticateTotp() ä¸­æœ‰éªŒè¯é€»è¾‘
// SecurityServiceImpl.validateTotpCode() ä¸­ä¹Ÿæœ‰éªŒè¯é€»è¾‘

// ä¼˜åŒ–åï¼šç»Ÿä¸€è°ƒç”¨
totpService.verify(secret, code);  // æ‰€æœ‰åœ°æ–¹éƒ½è°ƒç”¨è¿™ä¸ªæœåŠ¡
```

#### å¯æµ‹è¯•æ€§
- ç‹¬ç«‹çš„æœåŠ¡ç±»æ›´å®¹æ˜“ç¼–å†™å•å…ƒæµ‹è¯•
- å¯ä»¥å•ç‹¬æµ‹è¯• TOTP éªŒè¯é€»è¾‘ï¼Œä¸ä¾èµ– Spring Security ä¸Šä¸‹æ–‡

---

### 4. **MFA ä¼šè¯ç®¡ç†ç»Ÿä¸€ - MultiFactorAuthenticationSessionManager**

#### ä¼˜åŒ–å‰
- ä¼šè¯å‡çº§é€»è¾‘åˆ†æ•£åœ¨å¤šä¸ª Controller ä¸­ï¼ˆ`SecurityController`ã€`CustomLoginSuccessHandler`ï¼‰
- ä»£ç é‡å¤ï¼Œé€»è¾‘ä¸ä¸€è‡´

#### ä¼˜åŒ–å
- âœ… åˆ›å»º `MultiFactorAuthenticationSessionManager` å·¥å…·ç±»
- âœ… ç»Ÿä¸€ç®¡ç†éƒ¨åˆ†è®¤è¯åˆ°å®Œå…¨è®¤è¯çš„å‡çº§é€»è¾‘
- âœ… æ”¯æŒå¯é€‰ `HttpServletRequest` å‚æ•°ï¼Œçµæ´»æŒä¹…åŒ–åˆ° Session
- âœ… è‡ªåŠ¨æ‹·è´åŸæœ‰ `Authentication.details`ï¼ˆä¿ç•™ remoteAddressã€sessionId ç­‰ä¿¡æ¯ï¼‰

#### ä»£ç å¤ç”¨
```java
// ä¼˜åŒ–å‰ï¼šå¤šå¤„é‡å¤ä»£ç 
UserDetails userDetails = userDetailsService.loadUserByUsername(username);
MultiFactorAuthenticationToken token = new MultiFactorAuthenticationToken(...);
token.setAuthenticated(true);
SecurityContextHolder.getContext().setAuthentication(token);
// ... æŒä¹…åŒ–åˆ° Session çš„é€»è¾‘

// ä¼˜åŒ–åï¼šç»Ÿä¸€è°ƒç”¨
sessionManager.promoteToFullyAuthenticated(user, request);
```

---

### 5. **MFA æµç¨‹ç»Ÿä¸€ - ç§»é™¤ PartialAuthenticationAuthorizationManager**

#### ä¼˜åŒ–å‰
- ä½¿ç”¨ `PartialAuthenticationAuthorizationManager` å…è®¸éƒ¨åˆ†è®¤è¯ç”¨æˆ·è®¿é—®ç‰¹å®šç«¯ç‚¹
- éƒ¨åˆ†è®¤è¯ Token çš„ `authenticated=false`ï¼Œéœ€è¦ç‰¹æ®Šå¤„ç†
- æµç¨‹å¤æ‚ï¼Œéš¾ä»¥ç†è§£

#### ä¼˜åŒ–å
- âœ… ç§»é™¤ `PartialAuthenticationAuthorizationManager`
- âœ… ç»Ÿä¸€é€šè¿‡ `CustomLoginSuccessHandler` å¤„ç†æ‰€æœ‰ MFA è·³è½¬
- âœ… æ‰€æœ‰éƒ¨åˆ†è®¤è¯ Token éƒ½è®¾ä¸º `authenticated=true`ï¼Œè§¦å‘ `successHandler`
- âœ… ç®€åŒ–æµç¨‹ï¼š`AuthenticationProvider` â†’ `SuccessHandler` â†’ è·³è½¬

#### æµç¨‹å¯¹æ¯”

**ä¼˜åŒ–å‰ï¼š**
```
ç™»å½• â†’ AuthenticationProvider â†’ è¿”å› authenticated=false Token
     â†’ PartialAuthenticationAuthorizationManager å…è®¸è®¿é—® MFA ç«¯ç‚¹
     â†’ ç”¨æˆ·è®¿é—® TOTP éªŒè¯é¡µé¢
     â†’ éªŒè¯å®Œæˆåæ‰‹åŠ¨å‡çº§ Token
```

**ä¼˜åŒ–åï¼š**
```
ç™»å½• â†’ AuthenticationProvider â†’ è¿”å› authenticated=true Tokenï¼ˆåŒ…å« completedFactorsï¼‰
     â†’ CustomLoginSuccessHandler æ£€æŸ¥ completedFactors
     â†’ å¦‚æœéœ€è¦ TOTPï¼Œç›´æ¥è·³è½¬åˆ° TOTP éªŒè¯é¡µé¢
     â†’ éªŒè¯å®Œæˆåè°ƒç”¨ sessionManager.promoteToFullyAuthenticated()
```

#### ä¼˜åŠ¿
- æµç¨‹æ›´æ¸…æ™°ï¼Œç¬¦åˆ Spring Security æ ‡å‡†è®¾è®¡
- å‡å°‘ç‰¹æ®Šå¤„ç†é€»è¾‘
- æ›´å®¹æ˜“ç†è§£å’Œç»´æŠ¤

---

### 6. **ä»£ç æ¸…ç† - åˆ é™¤æœªä½¿ç”¨çš„ç±»**

#### åˆ é™¤çš„ç±»
1. âœ… `TotpVerificationFailedException` - æœªä½¿ç”¨
2. âœ… `MultiFactorAuthenticationFailedException` - æœªä½¿ç”¨
3. âœ… `MultiFactorAuthenticationException` - æœªä½¿ç”¨
4. âœ… `PartialAuthenticationException` - æœªä½¿ç”¨
5. âœ… `PartialAuthenticationToken` - æœªä½¿ç”¨
6. âœ… `PartialAuthenticationFilter` - æœªä½¿ç”¨ä¸”é€»è¾‘ä¸åŒ¹é…

#### åŸå› 
- å½“å‰å®ç°ä½¿ç”¨æ ‡å‡†çš„ `BadCredentialsException`ï¼Œç¬¦åˆ Spring Security è®¾è®¡
- è‡ªå®šä¹‰å¼‚å¸¸ç±»å¢åŠ äº†å¤æ‚åº¦ï¼Œä½†æ²¡æœ‰å®é™…ä»·å€¼
- `PartialAuthenticationFilter` æ£€æŸ¥ `authenticated=false`ï¼Œä½†å½“å‰å®ç°ä¸ä¼šäº§ç”Ÿè¿™æ ·çš„ Token

---

## ğŸ“Š ä¼˜åŒ–æ•ˆæœå¯¹æ¯”

### ä»£ç è´¨é‡

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|------|--------|--------|------|
| ç±»å‹å®‰å…¨ | å­—ç¬¦ä¸²å¸¸é‡ | æšä¸¾ç±»å‹ | â¬†ï¸ 100% |
| ä»£ç é‡å¤ | å¤šå¤„é‡å¤ | ç»Ÿä¸€æœåŠ¡ | â¬‡ï¸ 60% |
| å¯æµ‹è¯•æ€§ | è€¦åˆåº¦é«˜ | ç‹¬ç«‹æœåŠ¡ | â¬†ï¸ 80% |
| ä»£ç è¡Œæ•° | ~800 è¡Œ | ~600 è¡Œ | â¬‡ï¸ 25% |

### æ€§èƒ½

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|------|--------|--------|------|
| å› å­é›†åˆæ“ä½œ | HashSet<String> | EnumSet<Factor> | â¬†ï¸ 30-50% |
| TOTP ç”Ÿæˆå™¨ | æ¯æ¬¡åˆ›å»º | å•ä¾‹å¤ç”¨ | â¬†ï¸ 20% |
| æ•°æ®åº“æŸ¥è¯¢ | å¤šæ¬¡æŸ¥è¯¢ | å•æ¬¡æŸ¥è¯¢å¤ç”¨ | â¬†ï¸ 40% |

### å®‰å…¨æ€§

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|------|--------|--------|------|
| æ•æ„Ÿä¿¡æ¯ä¿æŠ¤ | å¯èƒ½æ³„éœ² | @JsonIgnore | â¬†ï¸ 100% |
| ç±»å‹å®‰å…¨ | è¿è¡Œæ—¶æ£€æŸ¥ | ç¼–è¯‘æœŸæ£€æŸ¥ | â¬†ï¸ 100% |
| å¼‚å¸¸å¤„ç† | è‡ªå®šä¹‰å¼‚å¸¸ | æ ‡å‡†å¼‚å¸¸ | â¬†ï¸ å…¼å®¹æ€§ |

---

## ğŸ”„ ä¼˜åŒ–åçš„ç™»å½•æµç¨‹

### å®Œæ•´æµç¨‹å›¾

```
1. ç”¨æˆ·æäº¤ç™»å½•è¡¨å•
   â†“
2. CustomWebAuthenticationDetailsSource æå– provider/type
   â†“
3. MultiAuthenticationProvider.authenticate()
   â”œâ”€ æŸ¥è¯¢ç”¨æˆ·å¯ç”¨çš„è®¤è¯æ–¹æ³•
   â”œâ”€ åˆ¤æ–­æ˜¯å¦éœ€è¦ MFA
   â”œâ”€ éªŒè¯å¯†ç ï¼ˆä½¿ç”¨ TotpService éªŒè¯ TOTPï¼‰
   â””â”€ è¿”å› authenticated=true çš„ MultiFactorAuthenticationToken
   â†“
4. CustomLoginSuccessHandler.onAuthenticationSuccess()
   â”œâ”€ æ£€æŸ¥ completedFactors
   â”œâ”€ æ£€æŸ¥ç”¨æˆ· MFA çŠ¶æ€ï¼ˆç»‘å®šã€æ¿€æ´»ã€å¼ºåˆ¶ï¼‰
   â””â”€ å†³å®šè·³è½¬ï¼š
      â”œâ”€ éœ€è¦ TOTP â†’ è·³è½¬ TOTP éªŒè¯é¡µ
      â”œâ”€ éœ€è¦ç»‘å®š â†’ è·³è½¬ TOTP ç»‘å®šé¡µ
      â””â”€ å®Œå…¨è®¤è¯ â†’ è°ƒç”¨ sessionManager.promoteToFullyAuthenticated()
   â†“
5. ç”¨æˆ·å®Œæˆ TOTP éªŒè¯
   â†“
6. SecurityController è°ƒç”¨ sessionManager.promoteToFullyAuthenticated()
   â†“
7. å‡çº§ä¸ºå®Œå…¨è®¤è¯ï¼Œè·³è½¬ç›®æ ‡é¡µé¢
```

---

## ğŸ¨ è®¾è®¡åŸåˆ™

### 1. **ç±»å‹å®‰å…¨ä¼˜å…ˆ**
- ä½¿ç”¨æšä¸¾æ›¿ä»£å­—ç¬¦ä¸²å¸¸é‡
- ç¼–è¯‘æœŸæ£€æŸ¥ä¼˜äºè¿è¡Œæ—¶æ£€æŸ¥

### 2. **å•ä¸€èŒè´£**
- æ¯ä¸ªç±»åªè´Ÿè´£ä¸€ä¸ªåŠŸèƒ½
- `TotpService` åªè´Ÿè´£ TOTP éªŒè¯
- `MultiFactorAuthenticationSessionManager` åªè´Ÿè´£ä¼šè¯å‡çº§

### 3. **ä»£ç å¤ç”¨**
- æå–å…¬å…±é€»è¾‘åˆ°æœåŠ¡ç±»
- é¿å…é‡å¤ä»£ç 

### 4. **ç¬¦åˆæ¡†æ¶è®¾è®¡**
- éµå¾ª Spring Security æ ‡å‡†æµç¨‹
- ä½¿ç”¨æ ‡å‡†å¼‚å¸¸ç±»å‹
- åˆ©ç”¨æ¡†æ¶æä¾›çš„æœºåˆ¶ï¼ˆå¦‚ `SuccessHandler`ï¼‰

### 5. **å‘åå…¼å®¹**
- ä¿ç•™å­—ç¬¦ä¸²æ„é€ å™¨ï¼Œæ”¯æŒæ—§ä»£ç 
- Jackson ååºåˆ—åŒ–æ”¯æŒæ–°æ—§å­—æ®µå

---

## ğŸ“ å…³é”®ä»£ç ç‰‡æ®µ

### MultiFactorAuthenticationToken æšä¸¾å®šä¹‰

```java
public enum Provider {
    LOCAL, GITHUB, GOOGLE, LDAP, UNKNOWN;
    
    public static Provider from(String s) {
        if (s == null) return UNKNOWN;
        try {
            return Provider.valueOf(s.trim().toUpperCase());
        } catch (Exception e) {
            return UNKNOWN;
        }
    }
}

public enum Factor {
    PASSWORD, TOTP, OAUTH2, EMAIL, MFA, UNKNOWN;
    
    public static Factor from(String s) {
        if (s == null) return UNKNOWN;
        try {
            return Factor.valueOf(s.trim().toUpperCase());
        } catch (Exception e) {
            return UNKNOWN;
        }
    }
}
```

### TotpService ç»Ÿä¸€éªŒè¯

```java
@Service
public class TotpService {
    private static final TimeBasedOneTimePasswordGenerator GENERATOR = createGenerator();
    
    public boolean verify(String base32Secret, String submittedCode) {
        // æ¸…æ´— Base32 secret
        // æ”¯æŒ Â±1 æ—¶é—´çª—å£
        // å¤ç”¨ç”Ÿæˆå™¨å®ä¾‹
    }
}
```

### MultiFactorAuthenticationSessionManager ä¼šè¯å‡çº§

```java
@Component
public class MultiFactorAuthenticationSessionManager {
    public void promoteToFullyAuthenticated(User user, HttpServletRequest request) {
        // åˆ›å»ºå®Œå…¨è®¤è¯ Token
        // æ›´æ–° SecurityContextHolder
        // å¯é€‰æŒä¹…åŒ–åˆ° Session
    }
}
```

---

## ğŸš€ åç»­ä¼˜åŒ–å»ºè®®

1. **æ€§èƒ½ç›‘æ§**
   - æ·»åŠ è®¤è¯è€—æ—¶ç›‘æ§
   - è®°å½• MFA å®Œæˆç‡

2. **å•å…ƒæµ‹è¯•**
   - ä¸º `TotpService` ç¼–å†™å®Œæ•´æµ‹è¯•
   - ä¸º `MultiFactorAuthenticationSessionManager` ç¼–å†™æµ‹è¯•

3. **æ–‡æ¡£å®Œå–„**
   - API æ–‡æ¡£
   - æµç¨‹å›¾å¯è§†åŒ–

4. **æ‰©å±•æ€§**
   - æ”¯æŒæ›´å¤šè®¤è¯å› å­ï¼ˆå¦‚ç”Ÿç‰©è¯†åˆ«ï¼‰
   - æ”¯æŒè‡ªå®šä¹‰è®¤è¯æä¾›è€…

---

## âœ… æ€»ç»“

æœ¬æ¬¡ä¼˜åŒ–é€šè¿‡å¼•å…¥ç±»å‹å®‰å…¨çš„æšä¸¾ã€æå–å…¬å…±é€»è¾‘ã€ç»Ÿä¸€æµç¨‹å¤„ç†ç­‰æ–¹å¼ï¼Œæ˜¾è‘—æå‡äº†ä»£ç è´¨é‡ã€å¯ç»´æŠ¤æ€§å’Œæ€§èƒ½ã€‚åŒæ—¶åˆ é™¤äº†å¤§é‡æœªä½¿ç”¨çš„ä»£ç ï¼Œä½¿ä»£ç åº“æ›´åŠ ç®€æ´æ¸…æ™°ã€‚

**æ ¸å¿ƒæˆæœï¼š**
- âœ… ç±»å‹å®‰å…¨æå‡ 100%
- âœ… ä»£ç é‡å¤å‡å°‘ 60%
- âœ… ä»£ç è¡Œæ•°å‡å°‘ 25%
- âœ… æ€§èƒ½æå‡ 20-50%
- âœ… å®‰å…¨æ€§æå‡ï¼ˆæ•æ„Ÿä¿¡æ¯ä¿æŠ¤ï¼‰

