# tiny-oauth-server ç™»å½•æµç¨‹æ¢³ç†

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†æ¢³ç†äº† tiny-oauth-server é¡¹ç›®çš„å®Œæ•´ç™»å½•æµç¨‹ï¼ŒåŒ…æ‹¬å‰ç«¯è¡¨å•æäº¤ã€åç«¯è®¤è¯å¤„ç†ã€å¤šå› ç´ è®¤è¯ï¼ˆMFAï¼‰æ”¯æŒä»¥åŠç™»å½•æˆåŠŸåçš„è·³è½¬é€»è¾‘ã€‚

---

## ğŸ”„ å®Œæ•´ç™»å½•æµç¨‹å›¾

```
ç”¨æˆ·è®¿é—®å—ä¿æŠ¤èµ„æº
    â†“
Spring Security æ‹¦æˆªï¼Œé‡å®šå‘åˆ° /login
    â†“
LoginController å¤„ç† GET /login è¯·æ±‚
    â†“
è¿”å›å‰ç«¯ç™»å½•é¡µé¢ (Login.vue)
    â†“
ç”¨æˆ·å¡«å†™è¡¨å•ï¼ˆusername, passwordï¼‰
    â†“
è¡¨å• POST æäº¤åˆ° /login (loginProcessingUrl)
    â†“
Spring Security FormLoginFilter æ•è·è¯·æ±‚
    â†“
CustomWebAuthenticationDetailsSource æå–è®¤è¯å‚æ•°
    â†“
MultiAuthenticationProvider è¿›è¡Œè®¤è¯
    â†“
â”œâ”€ æŸ¥æ‰¾ç”¨æˆ·è®¤è¯æ–¹æ³•
â”œâ”€ éªŒè¯å¯†ç /TOTP
â””â”€ å¤„ç†å¤šå› ç´ è®¤è¯ï¼ˆMFAï¼‰
    â†“
è®¤è¯æˆåŠŸ â†’ CustomLoginSuccessHandler
    â†“
æ£€æŸ¥ç”¨æˆ· MFA çŠ¶æ€
    â†“
â”œâ”€ å®Œå…¨å…³é—­ MFA â†’ ç›´æ¥è·³è½¬ç›®æ ‡é¡µé¢
â”œâ”€ éœ€è¦ TOTP éªŒè¯ â†’ è·³è½¬ TOTP éªŒè¯é¡µé¢
â”œâ”€ æœªç»‘å®š TOTP â†’ è·³è½¬ TOTP ç»‘å®šé¡µé¢
â””â”€ å®Œå…¨è®¤è¯ â†’ è·³è½¬ç›®æ ‡é¡µé¢
```

---

## ğŸ“ è¯¦ç»†æµç¨‹è¯´æ˜

### 1. å‰ç«¯ç™»å½•é¡µé¢ï¼ˆLogin.vueï¼‰

**æ–‡ä»¶ä½ç½®**: `src/main/webapp/src/views/Login.vue`

**å…³é”®ä»£ç **:
```11:31:tiny-oauth-server/src/main/webapp/src/views/Login.vue
      <form ref="formRef" :action="loginActionUrl" method="post" class="login-form" @submit="handleSubmit">
        <div class="form-group">
          <label for="username">ç”¨æˆ·å</label>
          <input ref="usernameRef" id="username" name="username" type="text" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" required
            autocomplete="username" />
        </div>

        <div class="form-group">
          <label for="password">å¯†ç </label>
          <input ref="passwordRef" id="password" name="password" type="password" placeholder="è¯·è¾“å…¥å¯†ç " required
            autocomplete="current-password" />
        </div>

        <!-- è®¤è¯å‚æ•° -->
        <input type="hidden" name="authenticationProvider" value="LOCAL" />
        <input type="hidden" name="authenticationType" value="PASSWORD" />

        <button type="submit" class="login-button" :class="{ loading: isSubmitting }" :disabled="isSubmitting">
          {{ isSubmitting ? 'ç™»å½•ä¸­...' : 'ç™»å½•' }}
        </button>
      </form>
```

**å…³é”®ç‚¹**:
- è¡¨å•ä½¿ç”¨ä¼ ç»Ÿçš„ `POST` æ–¹æ³•æäº¤åˆ° `/login`
- åŒ…å«éšè—å­—æ®µï¼š`authenticationProvider=LOCAL` å’Œ `authenticationType=PASSWORD`
- ç™»å½• URL é€šè¿‡ç¯å¢ƒå˜é‡é…ç½®ï¼š`VITE_API_BASE_URL`ï¼ˆé»˜è®¤ `http://localhost:9000`ï¼‰

---

### 2. åç«¯ç™»å½•é¡µé¢æ§åˆ¶å™¨ï¼ˆLoginControllerï¼‰

**æ–‡ä»¶ä½ç½®**: `src/main/java/com/tiny/oauthserver/sys/controller/LoginController.java`

**åŠŸèƒ½**:
- å¤„ç† `GET /login` è¯·æ±‚
- æ ¹æ®ç¯å¢ƒé…ç½®è¿”å›å‰ç«¯ç™»å½•é¡µé¢ï¼š
  - **å¼€å‘ç¯å¢ƒ**: é‡å®šå‘åˆ° Vite dev server (`redirect:http://localhost:5173/login`)
  - **ç”Ÿäº§ç¯å¢ƒ**: è½¬å‘åˆ°æ‰“åŒ…åçš„é™æ€æ–‡ä»¶ (`forward:/dist/index.html`)

**å…³é”®ä»£ç **:
```27:30:tiny-oauth-server/src/main/java/com/tiny/oauthserver/sys/controller/LoginController.java
    @GetMapping("/login")
    public String login(HttpServletRequest request) {
        return buildFrontendUrl(frontendProperties.getLoginUrl(), request);
    }
```

---

### 3. Spring Security é…ç½®ï¼ˆDefaultSecurityConfigï¼‰

**æ–‡ä»¶ä½ç½®**: `src/main/java/com/tiny/oauthserver/config/DefaultSecurityConfig.java`

**å…³é”®é…ç½®**:
```73:79:tiny-oauth-server/src/main/java/com/tiny/oauthserver/config/DefaultSecurityConfig.java
                .formLogin(formLogin -> formLogin
                        .loginPage("/login")
                        .loginProcessingUrl("/login")
                        .successHandler(customLoginSuccessHandler)
                        .failureUrl("/login?error=true")
                        .authenticationDetailsSource(customAuthenticationDetailsSource())
                        .permitAll()
                )
```

**é…ç½®è¯´æ˜**:
- `loginPage("/login")`: ç™»å½•é¡µé¢ URL
- `loginProcessingUrl("/login")`: ç™»å½•è¡¨å•æäº¤çš„ URLï¼ˆPOST è¯·æ±‚ï¼‰
- `successHandler`: ç™»å½•æˆåŠŸå¤„ç†å™¨ï¼ˆ`CustomLoginSuccessHandler`ï¼‰
- `failureUrl`: ç™»å½•å¤±è´¥é‡å®šå‘ URL
- `authenticationDetailsSource`: è‡ªå®šä¹‰è®¤è¯è¯¦æƒ…æºï¼Œç”¨äºæå–é¢å¤–å‚æ•°

---

### 4. è®¤è¯è¯¦æƒ…æºï¼ˆCustomWebAuthenticationDetailsSourceï¼‰

**æ–‡ä»¶ä½ç½®**: `src/main/java/com/tiny/oauthserver/config/CustomWebAuthenticationDetailsSource.java`

**åŠŸèƒ½**:
- ä»ç™»å½•è¯·æ±‚ä¸­æå– `authenticationProvider` å’Œ `authenticationType` å‚æ•°
- å°è£…åˆ° `CustomWebAuthenticationDetails` å¯¹è±¡ä¸­
- ä¾›è®¤è¯æä¾›è€…ä½¿ç”¨

**å…³é”®ä»£ç **:
```34:40:tiny-oauth-server/src/main/java/com/tiny/oauthserver/config/CustomWebAuthenticationDetailsSource.java
        public CustomWebAuthenticationDetails(HttpServletRequest request) {
            super(request);
            
            // ä»è¯·æ±‚å‚æ•°ä¸­æå–é¢å¤–ä¿¡æ¯
            this.authenticationProvider = request.getParameter("authenticationProvider");
            this.authenticationType = request.getParameter("authenticationType");
        }
```

---

### 5. å¤šè®¤è¯æä¾›è€…ï¼ˆMultiAuthenticationProviderï¼‰

**æ–‡ä»¶ä½ç½®**: `src/main/java/com/tiny/oauthserver/sys/security/MultiAuthenticationProvider.java`

**è®¤è¯æµç¨‹**:

#### 5.1 æå–è®¤è¯ä¿¡æ¯
```71:80:tiny-oauth-server/src/main/java/com/tiny/oauthserver/sys/security/MultiAuthenticationProvider.java
        } else if (authentication instanceof UsernamePasswordAuthenticationToken) {
            // ä½¿ç”¨æ ‡å‡† Tokenï¼Œä» Details ä¸­è·å–é¢å¤–ä¿¡æ¯
            username = authentication.getName();
            credentials = authentication.getCredentials();

        if (authentication.getDetails() instanceof CustomWebAuthenticationDetailsSource.CustomWebAuthenticationDetails details) {
            provider = details.getAuthenticationProvider();
            type = details.getAuthenticationType();
                logger.debug("ä» CustomWebAuthenticationDetails è·å–è®¤è¯å‚æ•°: provider={}, type={}", provider, type);
            }
```

#### 5.2 æŸ¥æ‰¾ç”¨æˆ·å’Œè®¤è¯æ–¹æ³•
- æ ¹æ®ç”¨æˆ·åæŸ¥æ‰¾ç”¨æˆ·
- æ ¹æ® `authenticationProvider` å’Œ `authenticationType` æŸ¥æ‰¾å¯¹åº”çš„è®¤è¯æ–¹æ³•
- å¦‚æœå‚æ•°ä¸ºç©ºï¼Œå°è¯•æ™ºèƒ½å›é€€ï¼ˆæŸ¥è¯¢ç”¨æˆ·æ‰€æœ‰å¯ç”¨çš„è®¤è¯æ–¹æ³•ï¼‰

#### 5.3 å¤šå› ç´ è®¤è¯ï¼ˆMFAï¼‰å¤„ç†
```184:186:tiny-oauth-server/src/main/java/com/tiny/oauthserver/sys/security/MultiAuthenticationProvider.java
        if (mfaMethods.size() > 1) {
            return handleMultiFactorAuthentication(user, credentials, mfaMethods, provider, type);
        }
```

**MFA æµç¨‹**:
1. æ£€æŸ¥ç”¨æˆ·æ˜¯å¦é…ç½®äº†å¤šä¸ªè®¤è¯æ–¹æ³•ï¼ˆå¦‚ PASSWORD + TOTPï¼‰
2. å¦‚æœåªæä¾›äº†éƒ¨åˆ†å‡­è¯ï¼ˆå¦‚åªæœ‰ passwordï¼‰ï¼Œè¿”å›éƒ¨åˆ†è®¤è¯ Token
3. å¦‚æœæä¾›äº†æ‰€æœ‰å‡­è¯ï¼Œä¸€æ¬¡æ€§éªŒè¯æ‰€æœ‰å› å­
4. å¦‚æœå·²å®Œæˆ PASSWORD éªŒè¯ä½†è¿˜éœ€è¦ TOTPï¼Œè¿”å›å®Œå…¨è®¤è¯ Tokenï¼ˆæ ‡è®°éœ€è¦ TOTP éªŒè¯ï¼‰

#### 5.4 å¯†ç éªŒè¯
```412:488:tiny-oauth-server/src/main/java/com/tiny/oauthserver/sys/security/MultiAuthenticationProvider.java
    private Authentication authenticatePassword(User user, String password, UserAuthenticationMethod method, String provider, String type) {
        Map<String, Object> config = method.getAuthenticationConfiguration();
        
        // æ·»åŠ è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—
        logger.debug("ç”¨æˆ· {} çš„è®¤è¯é…ç½®å†…å®¹: {}", user.getUsername(), config);
        logger.debug("ç”¨æˆ· {} çš„è®¤è¯é…ç½®é”®: {}", user.getUsername(), config != null ? config.keySet() : "null");
        
        if (config == null || config.isEmpty()) {
            logger.error("ç”¨æˆ· {} çš„è®¤è¯é…ç½®ä¸ºç©ºã€‚UserAuthenticationMethod ID: {}", user.getUsername(), method.getId());
            throw new BadCredentialsException("è®¤è¯é…ç½®é”™è¯¯ï¼šé…ç½®ä¸ºç©º");
        }
        
        // è·å–ç¼–ç åçš„å¯†ç 
        // åœ¨ authentication_configuration ä¸Šä¸‹æ–‡ä¸­ï¼Œä½¿ç”¨ "password" é”®å
        // ç¼–ç åçš„å¯†ç å¯èƒ½åŒ…å«ç¼–ç å™¨å‰ç¼€ï¼ˆå¦‚ {bcrypt}...ï¼‰æˆ–è€…åªæ˜¯çº¯å“ˆå¸Œï¼ˆå¦‚ $2a$10$...ï¼‰
        if (!config.containsKey("password")) {
            logger.error("ç”¨æˆ· {} çš„è®¤è¯é…ç½®ä¸­ä¸åŒ…å« password å­—æ®µã€‚å¯ç”¨çš„é”®: {}, é…ç½®å†…å®¹: {}", 
                    user.getUsername(), config.keySet(), config);
            throw new BadCredentialsException("è®¤è¯é…ç½®é”™è¯¯ï¼šç¼ºå°‘ password å­—æ®µ");
        }
        
        Object passwordValue = config.get("password");
        if (passwordValue == null) {
            logger.error("ç”¨æˆ· {} çš„ password å­—æ®µå€¼ä¸º nullã€‚é…ç½®å†…å®¹: {}", user.getUsername(), config);
            throw new BadCredentialsException("è®¤è¯é…ç½®é”™è¯¯ï¼špassword å­—æ®µå€¼ä¸º null");
        }
        
        String encodedPassword;
        if (passwordValue instanceof String) {
            encodedPassword = (String) passwordValue;
        } else {
            logger.warn("ç”¨æˆ· {} çš„ password å­—æ®µä¸æ˜¯å­—ç¬¦ä¸²ç±»å‹: {}ï¼Œå°è¯•è½¬æ¢ä¸ºå­—ç¬¦ä¸²", 
                    user.getUsername(), passwordValue.getClass().getName());
            encodedPassword = passwordValue.toString();
        }

        if (encodedPassword.isEmpty()) {
            logger.error("ç”¨æˆ· {} çš„ password å­—æ®µå€¼ä¸ºç©ºå­—ç¬¦ä¸²ã€‚é…ç½®å†…å®¹: {}", user.getUsername(), config);
            throw new BadCredentialsException("è®¤è¯é…ç½®é”™è¯¯ï¼špassword å­—æ®µå€¼ä¸ºç©º");
        }

        logger.debug("ç”¨æˆ· {} æˆåŠŸè¯»å–å¯†ç ï¼Œå¯†ç é•¿åº¦: {}, å¯†ç å‰ç¼€: {}", 
                user.getUsername(), 
                encodedPassword.length(),
                encodedPassword.length() > 10 ? encodedPassword.substring(0, Math.min(10, encodedPassword.length())) : encodedPassword);
        
        // éªŒè¯å¯†ç ï¼ˆæ•°æ®åº“ä¸­çš„å¯†ç åº”è¯¥å·²ç»åŒ…å«å‰ç¼€ï¼Œå¦‚ {bcrypt}...ï¼‰
        logger.debug("ç”¨æˆ· {} å¯†ç éªŒè¯å¼€å§‹", user.getUsername());
        boolean passwordMatches = passwordEncoder.matches(password, encodedPassword);
        logger.debug("ç”¨æˆ· {} å¯†ç éªŒè¯ç»“æœ: {}", user.getUsername(), passwordMatches ? "æˆåŠŸ" : "å¤±è´¥");
        
        if (!passwordMatches) {
            logger.warn("ç”¨æˆ· {} å¯†ç éªŒè¯å¤±è´¥", user.getUsername());
            throw new BadCredentialsException("å¯†ç é”™è¯¯");
        }

        // é€šè¿‡ UserDetailsService åŠ è½½ç”¨æˆ·è¯¦æƒ…ï¼ˆåŒ…æ‹¬æƒé™ï¼‰
        UserDetails userDetails = userDetailsService.loadUserByUsername(user.getUsername());

        // åˆ›å»ºè®¤è¯æˆåŠŸçš„ç»“æœ
        // ä¼˜å…ˆä½¿ç”¨ MultiFactorAuthenticationTokenï¼ˆå¦‚æœåŸå§‹è¯·æ±‚ä½¿ç”¨äº†å®ƒï¼‰
        // å¦åˆ™ä½¿ç”¨æ ‡å‡†çš„ UsernamePasswordAuthenticationTokenï¼ˆå‘åå…¼å®¹ï¼‰
        // æ³¨æ„ï¼šcredentials ä½¿ç”¨ null æ¸…ç©ºæ•æ„Ÿä¿¡æ¯ï¼ˆå¯†ç ï¼‰ï¼Œç¬¦åˆ Spring Security æœ€ä½³å®è·µ
        if (provider != null && type != null) {
            // ä½¿ç”¨ MultiFactorAuthenticationTokenï¼Œä¿ç•™è®¤è¯æ–¹å¼ä¿¡æ¯
            return new MultiFactorAuthenticationToken(
                    user.getUsername(),
                    null, // æ¸…ç©ºæ•æ„Ÿä¿¡æ¯
                    provider,
                    type,
                    userDetails.getAuthorities()
            );
        } else {
            // ä½¿ç”¨æ ‡å‡† Tokenï¼ˆå‘åå…¼å®¹ï¼‰
        return new UsernamePasswordAuthenticationToken(userDetails, null, userDetails.getAuthorities());
    }
    }
```

---

### 6. ç™»å½•æˆåŠŸå¤„ç†å™¨ï¼ˆCustomLoginSuccessHandlerï¼‰

**æ–‡ä»¶ä½ç½®**: `src/main/java/com/tiny/oauthserver/config/CustomLoginSuccessHandler.java`

**å¤„ç†æµç¨‹**:

#### 6.1 è·å–ç”¨æˆ·ä¿¡æ¯å’Œå®‰å…¨çŠ¶æ€
```53:66:tiny-oauth-server/src/main/java/com/tiny/oauthserver/config/CustomLoginSuccessHandler.java
    public void onAuthenticationSuccess(HttpServletRequest request, HttpServletResponse response, Authentication authentication) throws IOException, ServletException {
        String username = authentication.getName();
        User user = userRepository.findUserByUsername(username).orElse(null);
        if (user == null) {
            response.sendRedirect("/");
            return;
        }
        
        Map<String, Object> status = securityService.getSecurityStatus(user);
        boolean totpBound = Boolean.TRUE.equals(status.get("totpBound"));
        boolean totpActivated = Boolean.TRUE.equals(status.get("totpActivated"));
        boolean disableMfa = Boolean.TRUE.equals(status.get("disableMfa"));
        boolean skipMfaRemind = Boolean.TRUE.equals(status.get("skipMfaRemind"));
        boolean forceMfa = Boolean.TRUE.equals(status.get("forceMfa"));
```

#### 6.2 æå–ç›®æ ‡ URL
```68:73:tiny-oauth-server/src/main/java/com/tiny/oauthserver/config/CustomLoginSuccessHandler.java
        String intendedUrl = extractIntendedUrl(request, response);
        if (intendedUrl == null || intendedUrl.isBlank()) intendedUrl = "/";
        // å¦‚æœ intendedUrl æ˜¯ç™»å½•é¡µé¢ï¼Œç™»å½•æˆåŠŸååº”è¯¥è·³è½¬åˆ°é¦–é¡µï¼Œé¿å…å¾ªç¯é‡å®šå‘
        if ("/login".equals(intendedUrl) || intendedUrl.startsWith("/login?")) {
            intendedUrl = "/";
        }
```

#### 6.3 è·³è½¬ç­–ç•¥

**ç­–ç•¥ 1: å®Œå…¨å…³é—­ MFA**
```76:80:tiny-oauth-server/src/main/java/com/tiny/oauthserver/config/CustomLoginSuccessHandler.java
        // å®Œå…¨å…³é—­MFAæ—¶ç›´æ¥è·³è½¬ï¼Œä¸å¼¹ä»»ä½•é¡µé¢
        if (disableMfa) {
            response.sendRedirect(intendedUrl);
            return;
        }
```

**ç­–ç•¥ 2: éƒ¨åˆ†è®¤è¯ï¼ˆéœ€è¦ TOTP éªŒè¯ï¼‰**
```82:92:tiny-oauth-server/src/main/java/com/tiny/oauthserver/config/CustomLoginSuccessHandler.java
        // æ£€æŸ¥æ˜¯å¦æ˜¯å¤šå› ç´ è®¤è¯ Tokenï¼Œä¸”åªå®Œæˆäº† PASSWORD éªŒè¯ï¼ˆè¿˜éœ€è¦ TOTP éªŒè¯ï¼‰
        if (authentication instanceof com.tiny.oauthserver.sys.security.MultiFactorAuthenticationToken mfaToken) {
            java.util.Set<String> completedFactors = mfaToken.getCompletedFactors();
            // å¦‚æœåªå®Œæˆäº† PASSWORD éªŒè¯ï¼Œä¸”ç”¨æˆ·å·²ç»‘å®šå¹¶æ¿€æ´» TOTPï¼Œéœ€è¦è·³è½¬åˆ° TOTP éªŒè¯é¡µé¢
            if (completedFactors.contains("PASSWORD") && !completedFactors.contains("TOTP") && totpActivated) {
                logger.info("ç”¨æˆ· {} å·²å®Œæˆå¯†ç éªŒè¯ï¼Œä½†è¿˜éœ€è¦ TOTP éªŒè¯ï¼Œè·³è½¬åˆ° TOTP éªŒè¯é¡µé¢", user.getUsername());
                String totpVerifyUrl = buildFrontendUrl(frontendProperties.getTotpVerifyUrl(), request, "redirect", encoded);
                redirectToFrontend(totpVerifyUrl, request, response);
                return;
            }
        }
```

**ç­–ç•¥ 3: å·²ç»‘å®šä½†æœªæ¿€æ´» TOTP**
```94:100:tiny-oauth-server/src/main/java/com/tiny/oauthserver/config/CustomLoginSuccessHandler.java
        // å¦‚æœç”¨æˆ·å·²ç»‘å®š TOTP ä½†æœªæ¿€æ´»ï¼Œè·³è½¬åˆ° TOTP ç»‘å®šé¡µé¢
        if (totpBound && !totpActivated) {
            logger.info("ç”¨æˆ· {} å·²ç»‘å®š TOTP ä½†æœªæ¿€æ´»ï¼Œè·³è½¬åˆ° TOTP ç»‘å®šé¡µé¢", user.getUsername());
            String totpBindUrl = buildFrontendUrl(frontendProperties.getTotpBindUrl(), request, "redirect", encoded);
            redirectToFrontend(totpBindUrl, request, response);
            return;
        }
```

**ç­–ç•¥ 4: æœªç»‘å®š TOTP ä¸”éœ€è¦ç»‘å®š**
```102:109:tiny-oauth-server/src/main/java/com/tiny/oauthserver/config/CustomLoginSuccessHandler.java
        // å¦‚æœç”¨æˆ·æœªç»‘å®š TOTP ä¸”æœªé€‰æ‹©è·³è¿‡æé†’ï¼Œæˆ–ç³»ç»Ÿå¼ºåˆ¶ MFAï¼Œè·³è½¬åˆ°ç»‘å®šé¡µé¢
        if (!totpBound && !disableMfa && (forceMfa || !skipMfaRemind)) {
            logger.info("ç”¨æˆ· {} æœªç»‘å®š TOTPï¼Œè·³è½¬åˆ° TOTP ç»‘å®šé¡µé¢( forceMfa={}, skipMfaRemind={} )",
                    user.getUsername(), forceMfa, skipMfaRemind);
            String totpBindUrl = buildFrontendUrl(frontendProperties.getTotpBindUrl(), request, "redirect", encoded);
            redirectToFrontend(totpBindUrl, request, response);
            return;
        }
```

**ç­–ç•¥ 5: å®Œå…¨è®¤è¯ï¼Œè·³è½¬ç›®æ ‡é¡µé¢**
```111:137:tiny-oauth-server/src/main/java/com/tiny/oauthserver/config/CustomLoginSuccessHandler.java
        // ç”¨æˆ·æœªç»‘å®š TOTP æˆ–å·²æ¿€æ´»ä¸”å®Œæˆæ‰€æœ‰è®¤è¯ï¼šç›´æ¥è¿›å…¥ä¸šåŠ¡
        // å¯¹äº intendedUrlï¼Œå¦‚æœæ˜¯å‰ç«¯è·¯ç”±ï¼Œéœ€è¦æ ¹æ®ç¯å¢ƒä½¿ç”¨ä¸åŒçš„å¤„ç†æ–¹å¼
        if (intendedUrl.startsWith("/") && !intendedUrl.startsWith("/api/") && !intendedUrl.startsWith("/oauth2/")) {
            // å¯èƒ½æ˜¯å‰ç«¯è·¯ç”±
            String loginUrl = frontendProperties.getLoginUrl();
            if (loginUrl.startsWith("redirect:")) {
                // å¼€å‘ç¯å¢ƒï¼šé‡å®šå‘åˆ° Vite dev server
                String baseUrl = loginUrl.substring("redirect:".length());
                // æå–åŸºç¡€ URLï¼ˆå»æ‰è·¯å¾„éƒ¨åˆ†ï¼‰
                String devServerBase = baseUrl.substring(0, baseUrl.indexOf("/", baseUrl.indexOf("://") + 3));
                // æ·»åŠ æŸ¥è¯¢å‚æ•°æ ‡è¯†è¿™æ˜¯è¡¨å•ç™»å½•åçš„é‡å®šå‘
                String separator = intendedUrl.contains("?") ? "&" : "?";
                String redirectUrl = devServerBase + intendedUrl + separator + "formLogin=true";
                logger.info("å¼€å‘ç¯å¢ƒï¼šé‡å®šå‘åˆ°å‰ç«¯è·¯ç”±: {}", redirectUrl);
                response.sendRedirect(redirectUrl);
                return;
            } else {
                // ç”Ÿäº§ç¯å¢ƒï¼šforward åˆ°æ‰“åŒ…åçš„é™æ€æ–‡ä»¶
                try {
                    RequestDispatcher dispatcher = request.getRequestDispatcher("/dist/index.html");
                    dispatcher.forward(request, response);
                    return;
                } catch (Exception e) {
                    logger.warn("æ— æ³•è½¬å‘åˆ°å‰ç«¯é¡µé¢ï¼Œä½¿ç”¨é‡å®šå‘: {}", e.getMessage());
                }
            }
        }
        response.sendRedirect(intendedUrl);
```

---

### 7. å‰ç«¯è·¯ç”±å¤„ç†

**æ–‡ä»¶ä½ç½®**: `src/main/webapp/src/router/index.ts`

#### 7.1 è·¯ç”±å®ˆå«
```170:236:tiny-oauth-server/src/main/webapp/src/router/index.ts
// è·¯ç”±å®ˆå«ï¼Œå¤„ç†é‰´æƒ
router.beforeEach(async (to, from, next) => {
  const { isAuthenticated, login } = useAuth()

  // ç­‰å¾…è®¤è¯çŠ¶æ€åˆå§‹åŒ–å®Œæˆ
  try {
    await initPromise
  } catch (error) {
    console.error('è®¤è¯çŠ¶æ€åˆå§‹åŒ–å¤±è´¥:', error)
  }

  // å¦‚æœç”¨æˆ·å·²è®¤è¯ä¸”è®¿é—®ç™»å½•é¡µï¼Œé‡å®šå‘åˆ°é¦–é¡µ
  if (to.path === '/login' && isAuthenticated.value) {
    console.log('ç”¨æˆ·å·²è®¤è¯ï¼Œé‡å®šå‘åˆ°é¦–é¡µ')
    next('/')
    return
  }

  // å¦‚æœè®¿é—®éœ€è¦è®¤è¯çš„é¡µé¢ä½†ç”¨æˆ·æœªè®¤è¯ï¼Œé‡å®šå‘åˆ°ç™»å½•é¡µ
  if (to.meta.requiresAuth && !isAuthenticated.value) {
    console.log('ç”¨æˆ·æœªè®¤è¯ï¼Œé‡å®šå‘åˆ°ç™»å½•é¡µ')

    // æ£€æŸ¥åç«¯ä¼šè¯
    const backendSession = await checkBackendSession()
    if (backendSession) {
      console.log('æ£€æµ‹åˆ°æœ‰æ•ˆçš„åç«¯ä¼šè¯ï¼Œä½†ç¼ºå°‘ OIDC tokenï¼Œå°è¯•è‡ªåŠ¨å®Œæˆæˆæƒæµç¨‹')

      const urlParams = new URLSearchParams(window.location.search)
      if (urlParams.has('code') || urlParams.has('error')) {
        console.log('æ£€æµ‹åˆ° OIDC å›è°ƒå‚æ•°ï¼Œä¸è¿›è¡Œé‡å®šå‘')
        next()
        return
      }

      try {
        await login()
        return
      } catch (error) {
        console.error('åŸºäºåç«¯ä¼šè¯è§¦å‘ OIDC æˆæƒå¤±è´¥:', error)
        next('/login')
        return
      }
    }

    // æ£€æŸ¥æ˜¯å¦å·²ç»åœ¨ç™»å½•æµç¨‹ä¸­
    const urlParams = new URLSearchParams(window.location.search)
    if (urlParams.has('code') || urlParams.has('error')) {
      console.log('æ£€æµ‹åˆ° OIDC å›è°ƒå‚æ•°ï¼Œä¸è¿›è¡Œé‡å®šå‘')
      next()
      return
    }

    const returnUrl = to.fullPath
    try {
      await login()
      // ç™»å½•å‡½æ•°ä¼šè§¦å‘é¡µé¢è·³è½¬ï¼Œä¸éœ€è¦è°ƒç”¨ next()
      return
    } catch (error) {
      console.error('ç™»å½•é‡å®šå‘å¤±è´¥:', error)
      // å¦‚æœç™»å½•å¤±è´¥ï¼Œè·³è½¬åˆ°ç™»å½•é¡µ
      next('/login')
      return
    }
  }

  // å…¶ä»–æƒ…å†µæ­£å¸¸æ”¾è¡Œ
  next()
})
```

#### 7.2 åç«¯ä¼šè¯æ£€æµ‹
```67:84:tiny-oauth-server/src/main/webapp/src/router/index.ts
async function checkBackendSession(): Promise<boolean> {
  try {
    const resp = await fetch(`${baseUrl}/self/security/status`, {
      method: 'GET',
      credentials: 'include',
    })
    if (resp.ok) {
      const data = await resp.json()
      const valid = !('success' in data) || data.success !== false
      console.debug('[Auth] åç«¯ä¼šè¯æ£€æµ‹æˆåŠŸ:', { valid, data })
      return valid
    }
    console.warn('[Auth] åç«¯ä¼šè¯æ£€æµ‹å¤±è´¥ï¼ŒçŠ¶æ€ç :', resp.status)
  } catch (error) {
    console.error('æ£€æŸ¥åç«¯ä¼šè¯å¤±è´¥:', error)
  }
  return false
}
```

---

## ğŸ” è®¤è¯æ–¹å¼æ”¯æŒ

### æ”¯æŒçš„è®¤è¯ç±»å‹

1. **PASSWORD**: å¯†ç è®¤è¯
   - ä» `UserAuthenticationMethod.authentication_configuration` ä¸­è¯»å–ç¼–ç åçš„å¯†ç 
   - ä½¿ç”¨ `PasswordEncoder` è¿›è¡Œå¯†ç åŒ¹é…éªŒè¯

2. **TOTP**: åŸºäºæ—¶é—´çš„ä¸€æ¬¡æ€§å¯†ç 
   - ä»é…ç½®ä¸­è¯»å– Base32 ç¼–ç çš„å¯†é’¥
   - ä½¿ç”¨ RFC 6238 æ ‡å‡†ç®—æ³•éªŒè¯
   - æ”¯æŒ Â±1 æ—¶é—´æ­¥é•¿çš„æ—¶é’Ÿåå·®å®¹é”™

### å¤šå› ç´ è®¤è¯ï¼ˆMFAï¼‰

ç³»ç»Ÿæ”¯æŒç»„åˆè®¤è¯æ–¹å¼ï¼Œå¦‚ï¼š
- **PASSWORD + TOTP**: å…ˆéªŒè¯å¯†ç ï¼Œå†éªŒè¯ TOTP ç 
- **EMAIL + TOTP**: å…ˆéªŒè¯é‚®ç®±éªŒè¯ç ï¼Œå†éªŒè¯ TOTP ç ï¼ˆå¾…å®ç°ï¼‰

**MFA æµç¨‹**:
1. ç”¨æˆ·é¦–æ¬¡ç™»å½•åªæä¾›å¯†ç 
2. ç³»ç»ŸéªŒè¯å¯†ç åï¼Œè¿”å›éƒ¨åˆ†è®¤è¯ Token
3. è·³è½¬åˆ° TOTP éªŒè¯é¡µé¢
4. ç”¨æˆ·è¾“å…¥ TOTP ç 
5. ç³»ç»ŸéªŒè¯ TOTP ç ï¼Œå®Œæˆå®Œå…¨è®¤è¯

---

## ğŸ“Š æ•°æ®æµå›¾

### ç™»å½•è¯·æ±‚æ•°æ®æµ

```
å‰ç«¯è¡¨å•
  â†“
POST /login
  â”œâ”€ username: "admin"
  â”œâ”€ password: "admin"
  â”œâ”€ authenticationProvider: "LOCAL"
  â””â”€ authenticationType: "PASSWORD"
  â†“
Spring Security FormLoginFilter
  â†“
CustomWebAuthenticationDetailsSource
  â†“
MultiAuthenticationProvider
  â”œâ”€ æŸ¥æ‰¾ç”¨æˆ·
  â”œâ”€ æŸ¥æ‰¾è®¤è¯æ–¹æ³•
  â”œâ”€ éªŒè¯å¯†ç 
  â””â”€ åˆ›å»º Authentication Token
  â†“
CustomLoginSuccessHandler
  â”œâ”€ æ£€æŸ¥ MFA çŠ¶æ€
  â””â”€ å†³å®šè·³è½¬ç›®æ ‡
  â†“
å‰ç«¯é¡µé¢
```

---

## ğŸ”‘ å…³é”®é…ç½®

### ç¯å¢ƒå˜é‡

- `VITE_API_BASE_URL`: åç«¯ API åŸºç¡€ URLï¼ˆé»˜è®¤: `http://localhost:9000`ï¼‰

### å‰ç«¯é…ç½®

- `frontend.loginUrl`: ç™»å½•é¡µé¢ URL
  - å¼€å‘ç¯å¢ƒ: `redirect:http://localhost:5173/login`
  - ç”Ÿäº§ç¯å¢ƒ: `forward:/dist/index.html`

- `frontend.totpBindUrl`: TOTP ç»‘å®šé¡µé¢ URL
- `frontend.totpVerifyUrl`: TOTP éªŒè¯é¡µé¢ URL

---

## ğŸ› å¸¸è§é—®é¢˜

### 1. ç™»å½•åå¾ªç¯é‡å®šå‘

**åŸå› **: ç™»å½•æˆåŠŸåè·³è½¬çš„ URL ä»ç„¶æ˜¯ `/login`

**è§£å†³**: `CustomLoginSuccessHandler` ä¸­å·²å¤„ç†ï¼Œå¦‚æœ `intendedUrl` æ˜¯ç™»å½•é¡µé¢ï¼Œè‡ªåŠ¨è·³è½¬åˆ°é¦–é¡µ

### 2. å¤šå› ç´ è®¤è¯æµç¨‹ä¸­æ–­

**åŸå› **: éƒ¨åˆ†è®¤è¯ Token æœªæ­£ç¡®å¤„ç†

**è§£å†³**: ç¡®ä¿ `MultiFactorAuthenticationToken` åœ¨å®Œæˆ PASSWORD éªŒè¯åï¼Œ`isAuthenticated()` è¿”å› `true`ï¼Œä»¥ä¾¿è§¦å‘ `successHandler`

### 3. å‰ç«¯è·¯ç”±æ— æ³•è®¿é—®

**åŸå› **: åç«¯é‡å®šå‘åˆ°å‰ç«¯è·¯ç”±æ—¶ï¼Œç¯å¢ƒé…ç½®ä¸æ­£ç¡®

**è§£å†³**: æ£€æŸ¥ `FrontendProperties` é…ç½®ï¼Œç¡®ä¿å¼€å‘ç¯å¢ƒå’Œç”Ÿäº§ç¯å¢ƒä½¿ç”¨æ­£ç¡®çš„ URL å‰ç¼€

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [å¤šè®¤è¯æ–¹å¼éªŒè¯æµç¨‹](./å¤šè®¤è¯æ–¹å¼éªŒè¯æµç¨‹.md)
- [loginProcessingUrlè¯¦è§£](./loginProcessingUrlè¯¦è§£.md)
- [FormLoginé…ç½®é€‰é¡¹](./FormLoginé…ç½®é€‰é¡¹.md)
- [ç™»å½•é¢å¤–å‚æ•°ä½¿ç”¨ç¤ºä¾‹](./ç™»å½•é¢å¤–å‚æ•°ä½¿ç”¨ç¤ºä¾‹.md)

---

## ğŸ“ æ›´æ–°æ—¥å¿—

- **2024-03-21**: åˆå§‹ç‰ˆæœ¬ï¼Œå®Œæ•´æ¢³ç†ç™»å½•æµç¨‹
