# ç™»å½•é¢å¤–å‚æ•°ä½¿ç”¨ç¤ºä¾‹

## ğŸ“‹ æ¦‚è¿°

å½“å‰ç™»å½•è¡¨å•å·²é…ç½®ä¸ºè‡ªåŠ¨ä¼ å…¥ä»¥ä¸‹å‚æ•°ï¼š

- `authenticationProvider = "LOCAL"`
- `authenticationType = "PASSWORD"`

è¿™äº›å‚æ•°ä¼šè¢« Spring Security æ•è·å¹¶å¯åœ¨è®¤è¯è¿‡ç¨‹ä¸­è®¿é—®ã€‚

---

## ğŸ”§ é…ç½®ä½ç½®

### 1. è¡¨å•å­—æ®µï¼ˆlogin.htmlï¼‰

```158:160:tiny-oauth-server/src/main/resources/templates/login.html
            <!-- è®¤è¯ç›¸å…³å‚æ•° -->
            <input type="hidden" name="authenticationProvider" value="LOCAL" />
            <input type="hidden" name="authenticationType" value="PASSWORD" />
```

### 2. Spring Security é…ç½®ï¼ˆDefaultSecurityConfig.javaï¼‰

```88:91:tiny-oauth-server/src/main/java/com/tiny/oauthserver/config/DefaultSecurityConfig.java
    @Bean
    public AuthenticationDetailsSource<HttpServletRequest, WebAuthenticationDetails> customAuthenticationDetailsSource() {
        return new CustomWebAuthenticationDetailsSource();
    }
```

---

## ğŸ’» åœ¨ä»£ç ä¸­è®¿é—®è¿™äº›å‚æ•°

### æ–¹å¼ä¸€ï¼šåœ¨ Controller ä¸­è®¿é—®

```java
@GetMapping("/dashboard")
public String dashboard(Authentication authentication) {
    if (authentication.getDetails() instanceof CustomWebAuthenticationDetailsSource.CustomWebAuthenticationDetails) {
        CustomWebAuthenticationDetailsSource.CustomWebAuthenticationDetails details =
            (CustomWebAuthenticationDetailsSource.CustomWebAuthenticationDetails) authentication.getDetails();

        String provider = details.getAuthenticationProvider(); // "LOCAL"
        String type = details.getAuthenticationType();         // "PASSWORD"

        System.out.println("Provider: " + provider);
        System.out.println("Type: " + type);
    }

    return "dashboard";
}
```

### æ–¹å¼äºŒï¼šåœ¨ UserDetailsService ä¸­è®¿é—®

å¦‚æœéœ€è¦æ ¹æ®ä¸åŒè®¤è¯ç±»å‹åŠ è½½ç”¨æˆ·ï¼š

```java
@Service
public class UserDetailsServiceImpl implements UserDetailsService {

    @Override
    public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException {
        // æ³¨æ„ï¼šåœ¨ UserDetailsService ä¸­æ— æ³•ç›´æ¥è®¿é—® AuthenticationDetails
        // éœ€è¦é€šè¿‡å…¶ä»–æ–¹å¼ä¼ é€’å‚æ•°ï¼ˆå¦‚ HTTP å¤´ã€ThreadLocal ç­‰ï¼‰
        User user = userRepository.findUserByUsername(username)
            .orElseThrow(() -> new UsernameNotFoundException("ç”¨æˆ·ä¸å­˜åœ¨"));

        return new SecurityUser(user);
    }
}
```

### æ–¹å¼ä¸‰ï¼šåœ¨è‡ªå®šä¹‰ AuthenticationProvider ä¸­è®¿é—®

```java
@Component
public class CustomAuthenticationProvider implements AuthenticationProvider {

    @Override
    public Authentication authenticate(Authentication authentication) {
        String provider = null;
        String type = null;

        if (authentication.getDetails() instanceof CustomWebAuthenticationDetailsSource.CustomWebAuthenticationDetails) {
            CustomWebAuthenticationDetailsSource.CustomWebAuthenticationDetails details =
                (CustomWebAuthenticationDetailsSource.CustomWebAuthenticationDetails) authentication.getDetails();

            provider = details.getAuthenticationProvider();
            type = details.getAuthenticationType();
        }

        // æ ¹æ® provider å’Œ type è¿›è¡Œä¸åŒçš„è®¤è¯é€»è¾‘
        if ("LOCAL".equals(provider) && "PASSWORD".equals(type)) {
            // æœ¬åœ°å¯†ç è®¤è¯é€»è¾‘
            return authenticateLocalPassword(authentication);
        } else if ("LOCAL".equals(provider) && "TOTP".equals(type)) {
            // TOTP è®¤è¯é€»è¾‘
            return authenticateTOTP(authentication);
        }

        throw new AuthenticationException("ä¸æ”¯æŒçš„è®¤è¯ç±»å‹");
    }
}
```

### æ–¹å¼å››ï¼šåœ¨ AuthenticationSuccessHandler ä¸­è®¿é—®

```java
public class CustomAuthenticationSuccessHandler implements AuthenticationSuccessHandler {

    @Override
    public void onAuthenticationSuccess(HttpServletRequest request,
                                       HttpServletResponse response,
                                       Authentication authentication) throws IOException {

        if (authentication.getDetails() instanceof CustomWebAuthenticationDetailsSource.CustomWebAuthenticationDetails) {
            CustomWebAuthenticationDetailsSource.CustomWebAuthenticationDetails details =
                (CustomWebAuthenticationDetailsSource.CustomWebAuthenticationDetails) authentication.getDetails();

            String provider = details.getAuthenticationProvider();
            String type = details.getAuthenticationType();

            // è®°å½•ç™»å½•æ—¥å¿—
            log.info("ç”¨æˆ· {} ä½¿ç”¨ {}/{} æ–¹å¼ç™»å½•æˆåŠŸ",
                authentication.getName(), provider, type);

            // å­˜å‚¨åˆ° Session
            request.getSession().setAttribute("provider", provider);
            request.getSession().setAttribute("type", type);
        }

        response.sendRedirect("/");
    }
}
```

---

## ğŸ“ å®é™…åº”ç”¨åœºæ™¯

### åœºæ™¯ 1ï¼šå¤šè®¤è¯æ–¹å¼æ”¯æŒ

ä½ çš„ç³»ç»Ÿæ”¯æŒå¤šç§è®¤è¯æ–¹å¼ï¼š

- LOCAL + PASSWORDï¼ˆæœ¬åœ°å¯†ç ï¼‰
- LOCAL + TOTPï¼ˆåŒå› ç´ è®¤è¯ï¼‰
- GITHUBï¼ˆGitHub OAuthï¼‰
- GOOGLEï¼ˆGoogle OAuthï¼‰

è¿™äº›å‚æ•°å¯ä»¥å¸®åŠ©ä½ è¯†åˆ«ç”¨æˆ·ä½¿ç”¨çš„è®¤è¯æ–¹å¼ã€‚

### åœºæ™¯ 2ï¼šå®¡è®¡æ—¥å¿—

è®°å½•ç”¨æˆ·ç™»å½•æ—¶çš„è®¤è¯æ–¹å¼ï¼š

```java
@PostMapping("/login")
public void logLogin(Authentication authentication) {
    if (authentication.getDetails() instanceof CustomWebAuthenticationDetails) {
        CustomWebAuthenticationDetails details =
            (CustomWebAuthenticationDetails) authentication.getDetails();

        auditLogService.log(
            authentication.getName(),
            details.getAuthenticationProvider(),
            details.getAuthenticationType()
        );
    }
}
```

### åœºæ™¯ 3ï¼šåŠ¨æ€è°ƒæ•´è®¤è¯æµç¨‹

æ ¹æ®è®¤è¯ç±»å‹é€‰æ‹©ä¸åŒçš„è®¤è¯é€»è¾‘ï¼š

```java
public class MultiAuthProvider implements AuthenticationProvider {

    @Override
    public Authentication authenticate(Authentication authentication) {
        CustomWebAuthenticationDetails details =
            (CustomWebAuthenticationDetails) authentication.getDetails();

        String provider = details.getAuthenticationProvider();
        String type = details.getAuthenticationType();

        switch (provider + "_" + type) {
            case "LOCAL_PASSWORD":
                return authenticateWithPassword(authentication);
            case "LOCAL_TOTP":
                return authenticateWithTOTP(authentication);
            case "GITHUB_OAUTH":
                return authenticateWithGitHub(authentication);
            default:
                throw new AuthenticationException("ä¸æ”¯æŒçš„è®¤è¯æ–¹å¼");
        }
    }
}
```

---

## ğŸ” è°ƒè¯•å’Œæµ‹è¯•

### æŸ¥çœ‹å‚æ•°å€¼

åœ¨ç™»å½•è¿‡ç¨‹ä¸­æ·»åŠ æ—¥å¿—ï¼š

```java
@Component
public class LoginDetailsLogger {

    @EventListener
    public void onAuthenticationSuccess(AuthenticationSuccessEvent event) {
        Authentication auth = event.getAuthentication();
        if (auth.getDetails() instanceof CustomWebAuthenticationDetails) {
            CustomWebAuthenticationDetails details =
                (CustomWebAuthenticationDetails) auth.getDetails();

            log.info("ç™»å½•è¯¦æƒ…: provider={}, type={}",
                details.getAuthenticationProvider(),
                details.getAuthenticationType());
        }
    }
}
```

### æ‰‹åŠ¨æµ‹è¯•

ä½¿ç”¨ curl æµ‹è¯•ï¼š

```bash
curl -X POST http://localhost:9000/login \
  -d "username=admin&password=123456" \
  -d "authenticationProvider=LOCAL" \
  -d "authenticationType=PASSWORD"
```

---

## ğŸ“š ç›¸å…³æ–‡ä»¶

- `CustomWebAuthenticationDetailsSource.java` - è‡ªå®šä¹‰è¯¦æƒ…æº
- `DefaultSecurityConfig.java` - Security é…ç½®
- `login.html` - ç™»å½•è¡¨å•
