DEBUGworkflow:
  engine: camunda # 或 flowable, activiti
server:
  port: 9000
  servlet:
    session:
      cookie:
        name: JSESSIONID
        http-only: true # HttpOnly：防止 XSS 攻击，JavaScript 无法访问 Cookie
        secure: false # Secure：开发环境使用 HTTP，设为 false；生产环境在 application-prod.yaml 中设为 true
        same-site: Lax # SameSite：Lax 允许从外部链接跳转时携带 Cookie，Strict 更严格但可能影响用户体验
spring:
  application:
    name: oauth-server
  # JMX 配置：禁用 JMX 以避免 RMI 连接时的 InstanceNotFoundException
  # 如果不需要 JMX 监控，建议禁用以减少日志噪音
  jmx:
    enabled: false
  quartz:
    job-store-type: jdbc # 使用数据库存储调度元数据，确保多节点共享
    jdbc:
      initialize-schema: never # 由 Flyway/Liquibase 管理 QRTZ_* 表，避免启动时被重建
    scheduler-name: DagScheduler # Scheduler 名称，可在集群中唯一标识
    startup-delay: 10s # 应用启动后延迟触发 Quartz 初始化，确保数据源就绪
    overwrite-existing-jobs: true # 启动时覆盖已存在的 Job 定义，便于自动部署
    wait-for-jobs-to-complete-on-shutdown: true # 优雅停机：等待任务执行完毕后再关闭
    properties:
      # ---------------- Scheduler 基础配置 ----------------
      org.quartz.scheduler.instanceName: DagScheduler # Quartz Scheduler 名称
      org.quartz.scheduler.instanceId: AUTO # AUTO 根据主机/时间生成唯一实例 ID
      org.quartz.scheduler.skipUpdateCheck: true # 关闭官方更新检查，避免外网访问
      org.quartz.scheduler.batchTriggerAcquisitionMaxCount: 12 # 批量拉取 Trigger 的最大数量
      org.quartz.scheduler.batchTriggerAcquisitionFireAheadTimeWindow: 60000 # 提前多久加载触发器 (ms)

      # ---------------- JobStore 配置 ----------------
      org.quartz.jobStore.class: org.springframework.scheduling.quartz.LocalDataSourceJobStore # Spring 托管的 JDBC JobStore
      org.quartz.jobStore.driverDelegateClass: org.quartz.impl.jdbcjobstore.StdJDBCDelegate # MySQL 通用 Delegate
      org.quartz.jobStore.tablePrefix: QRTZ_ # Quartz 表前缀
      org.quartz.jobStore.isClustered: true # 启用集群
      org.quartz.jobStore.clusterCheckinInterval: 20000 # 集群实例心跳频率 (ms)
      org.quartz.jobStore.misfireThreshold: 60000 # 触发器误触发阈值 (ms)
      org.quartz.jobStore.acquireTriggersWithinLock: true # 获取 Trigger 时加锁，避免多节点冲突
      org.quartz.jobStore.maxMisfiresToHandleAtATime: 20 # 单次处理的最大 misfire 数，平衡恢复速度

      # ---------------- 线程池配置 ----------------
      org.quartz.threadPool.class: org.quartz.simpl.SimpleThreadPool # 轻量级线程池实现
      org.quartz.threadPool.threadCount: 10 # 工作线程数量
      org.quartz.threadPool.threadPriority: 5 # 工作线程优先级，默认 5 (Normal)
      org.quartz.threadPool.threadsInheritContextClassLoaderOfInitializingThread: true # 继承上下文类加载器，避免类找不到

      # ---------------- Listener / Plugin 示例 ----------------
      org.quartz.plugin.triggHistory.class: org.quartz.plugins.history.LoggingTriggerHistoryPlugin # 记录 Trigger 执行历史
      org.quartz.plugin.triggHistory.triggerFiredMessage: "Trigger {1}.{0} fired job {6}.{5} at {4}" # 自定义日志模板
  datasource:
    url: >-
      jdbc:mysql://localhost:3306/tiny_web
      ?useSSL=false
      &allowPublicKeyRetrieval=true
      &useUnicode=true
      &characterEncoding=UTF-8
      &serverTimezone=Asia/Shanghai
      &sessionVariables=transaction_isolation='READ-COMMITTED'
      &rewriteBatchedStatements=true
      &cachePrepStmts=true
      &prepStmtCacheSize=250
      &prepStmtCacheSqlLimit=2048
      &useServerPrepStmts=true
    #url: jdbc:mysql://localhost:3306/tiny_web?useSSL=false&allowPublicKeyRetrieval=true&characterEncoding=utf8&serverTimezone=Asia/Shanghai&sessionVariables=transaction_isolation='READ-COMMITTED'
    username: root
    password: Tianye0903.
    driver-class-name: com.mysql.cj.jdbc.Driver
    hikari:
      minimum-idle: 5 # HikariCP 连接池最小空闲连接数，默认10
      maximum-pool-size: 20 # HikariCP 连接池最大连接数，默认10
      idle-timeout: 30000 # HikariCP 连接池中连接最大空闲时间（毫秒），默认600000（10分钟）
      pool-name: HikariCP # HikariCP 连接池名称，默认HikariPool-1
      max-lifetime: 1800000 # HikariCP 连接的最大存活时间（毫秒），默认1800000（30分钟）
      connection-timeout: 30000 # HikariCP 获取连接的最大等待时间（毫秒），默认30000（30秒）
      auto-commit: true # HikariCP 是否自动提交，默认true
      # 设置事务隔离级别为 READ_COMMITTED
      connection-init-sql: "SET SESSION TRANSACTION ISOLATION LEVEL READ COMMITTED"
  jpa:
    # 移除 database-platform 配置，Hibernate 会根据数据库 URL 自动选择正确的方言
    # 如需显式指定，使用: org.hibernate.dialect.MySQLDialect (MySQL8Dialect 已弃用)
    open-in-view: false # 避免延迟加载导致的 session 泄露警告

    hibernate:
      ddl-auto: update # JPA 自动建表策略，update为自动更新表结构,生产环境建议改为 none
    show-sql: true # 是否显示SQL语句，开发时建议开启
    properties:
      hibernate:
        format_sql: true
        jdbc:
          time_zone: Asia/Shanghai
          batch_size: 50
        order_inserts: true
        order_updates: true
  # 数据初始化配置
  # 注意：已迁移到 Liquibase，禁用 Spring SQL 初始化以避免冲突
  sql:
    init:
      mode: never # 禁用 Spring SQL 初始化，由 Liquibase 统一管理数据库变更
  liquibase:
    enabled: true
    change-log: classpath:db/changelog/db.changelog-master.yaml
  profiles:
    active: dev

  # Jackson 配置
  #jackson:
  #  serialization:
  #    write-dates-as-timestamps: false # 使用 ISO-8601 格式而不是时间戳
  #  default-property-inclusion: non_null # 不序列化 null 值
authentication:
  jwt:
    public-key-path: classpath:keys/public.pem
    private-key-path: classpath:keys/private.pem
  clients:
    - client-id: oidc-client
      client-secret: secret
      authentication-methods:
        - client_secret_basic
      grant-types:
        - authorization_code
        - refresh_token
      redirect-uris:
        - http://localhost:9000/
      post-logout-redirect-uris:
        - http://localhost:5173/
      scopes:
        - openid
        - profile
      client-setting:
        require-authorization-consent: true
    - client-id: vue-client
      authentication-methods:
        - none # ✅ 表示前端（公有客户端）不需要 client secret
      grant-types:
        - authorization_code # ✅ 标准 OIDC 授权码流程
        - refresh_token # ✅ 启用 refresh_token 支持
      redirect-uris:
        - http://localhost:5173/callback
        - http://localhost:5173/silent-renew.html # silent renew 时用于隐式授权流程的 iframe 回调页面。
      post-logout-redirect-uris:
        - http://localhost:5173/
      scopes:
        - openid
        - profile
        - offline_access # ✅ 必须启用，否则不会发 refresh_token
      client-setting:
        require-authorization-consent: false
        require-proof-key: true # ✅ 强制启用 PKCE，确保公有客户端也能安全获取 refresh_token
# Camunda BPM 配置
camunda:
  bpm:
    #admin-user:
    #  id: admin
    #  password: admin
    database:
      type: mysql
      schema-update: false # 强制重新创建所有表
    generic-properties:
      properties:
        dbIdentityUsed: false # 关键：不使用 ACT_ID_* 身份表
        tenantCheckEnabled: true
    webapp:
      enabled: false # 禁用 Camunda Webapp
    job-execution:
      enabled: true # 启用作业执行
    metrics:
      enabled: true # 启用指标收集
    # 历史数据配置
    history-level: full # 记录完整历史数据
    default-history-time-to-live: 30 # 默认历史数据生存时间（天）
    # 历史数据清理配置
    history-cleanup:
      enabled: true # 启用历史数据清理
      batch-window-start-time: "02:00" # 清理开始时间
      batch-window-end-time: "06:00" # 清理结束时间
      batch-size: 100 # 清理批次大小
    # 流程引擎配置
    process-engine:
      enforce-history-time-to-live: false # 临时禁用 TTL 强制检查
security:
  mfa:
    mode: OPTIONAL # MFA模式: NONE(完全禁用), OPTIONAL(推荐可跳过), REQUIRED(强制必须绑定)

# 前端页面配置
# 默认配置为生产环境（forward 到打包后的静态文件）
# 开发环境请使用 application-dev.yaml 覆盖配置
#frontend:
#  login-url: forward:/dist/index.html
#  totp-bind-url: forward:/dist/index.html
#  totp-verify-url: forward:/dist/index.html
