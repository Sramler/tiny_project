<!DOCTYPE html>
<html>
<head>
    <title>Silent Renew</title>
    <script type="module">
        import { UserManager } from 'https://cdn.jsdelivr.net/npm/oidc-client-ts/+esm'

        // 与主应用保持一致的 TRACE_ID 生成 / 管理逻辑（简化版）
        function generateTraceId() {
            return crypto.randomUUID().replace(/-/g, '');
        }

        function getOrCreateTraceId() {
            try {
                const storageKey = 'app_trace_id';
                let traceId = sessionStorage.getItem(storageKey);
                if (!traceId) {
                    traceId = generateTraceId();
                    sessionStorage.setItem(storageKey, traceId);
                }
                return traceId;
            } catch (e) {
                // 极端场景下 sessionStorage 不可用时，退回一次性 traceId
                return generateTraceId();
            }
        }

        // 安装针对授权服务器的 fetch 包装，自动注入 TRACE_ID header
        function installOidcFetchWithTraceId(authority) {
            if (typeof window === 'undefined' || typeof window.fetch !== 'function') {
                return;
            }

            const anyWindow = window;
            if (anyWindow.__oidcTraceFetchInstalled) {
                return;
            }
            anyWindow.__oidcTraceFetchInstalled = true;

            const originalFetch = window.fetch.bind(window);

            window.fetch = (input, init) => {
                try {
                    const urlString =
                        typeof input === 'string' || input instanceof URL ? input.toString() : input.url;

                    // 仅对指向同一 authority 的请求注入 traceId，避免影响其他第三方域名
                    if (urlString.startsWith(authority)) {
                        const traceId = getOrCreateTraceId();
                        const headers = new Headers(init && init.headers ? init.headers : undefined);
                        headers.set('X-Trace-Id', traceId);
                        headers.set('X-Request-Id', traceId.substring(0, 16));

                        const optionsWithTrace = {
                            ...(init || {}),
                            headers,
                        };
                        return originalFetch(input, optionsWithTrace);
                    }
                } catch (e) {
                    console.warn('[OIDC][silent-renew][trace] 安装 fetch traceId 包装时出错，回退到原始 fetch', e);
                }

                return originalFetch(input, init);
            };
        }

        const userManager = new UserManager({ response_mode: 'query' });

        // 使用 userManager 的配置确定 authority，再安装 fetch 包装
        if (userManager.settings && userManager.settings.authority) {
            installOidcFetchWithTraceId(userManager.settings.authority);
        }

        userManager.signinSilentCallback()
            .then(() => console.log('[OIDC] Silent renew completed'))
            .catch(err => console.error('[OIDC] Silent renew error', err))
    </script>
</head>
<body></body>
</html>